# 宝塔面板部署指南

本指南将帮助您在宝塔面板上部署 Discord Bot 转发工具。

## 📋 前置要求

- 已安装宝塔面板（Linux 系统）
- 服务器可以访问 Discord API（可能需要代理）
- 已获取 Discord Bot Token 或 SelfBot Token

## 🚀 部署步骤

### 1. 安装 Node.js 环境

1. 登录宝塔面板
2. 进入 **软件商店** → 搜索 **Node.js 版本管理器**
3. 安装 **Node.js 版本管理器**
4. 打开 **Node.js 版本管理器**，安装 **Node.js 18.x** 或更高版本（推荐 18.x LTS）
5. 安装 **pnpm**（在 Node.js 版本管理器中，或使用命令：`npm install -g pnpm`）

### 2. 上传项目文件

#### 方式一：通过宝塔文件管理器上传

1. 在宝塔面板中，进入 **文件** 管理
2. 创建项目目录，例如：`/www/wwwroot/discord-bot`
3. 将项目所有文件上传到此目录（**不要上传** `node_modules`、`dist-bot`、`dist-server`、`.data` 等目录）

#### 方式二：通过 Git 克隆（推荐）

1. 在宝塔面板中，进入 **终端**
2. 执行以下命令：

```bash
cd /www/wwwroot
git clone <你的仓库地址> discord-bot
cd discord-bot
```

### 3. 安装项目依赖

在宝塔 **终端** 中，进入项目目录并安装依赖：

```bash
cd /www/wwwroot/discord-bot
pnpm install
```

### 4. 编译项目

```bash
# 编译 Bot 代码
pnpm build:bot

# 编译服务器代码（如果需要管理界面）
pnpm build:server
```

### 5. 配置环境变量（可选）

如果需要设置代理或自定义端口，创建 `.env` 文件：

```bash
cd /www/wwwroot/discord-bot
nano .env
```

添加以下内容（根据需要修改）：

```env
# 代理地址（可选，如果需要代理访问 Discord）
PROXY_URL=http://127.0.0.1:7890

# 管理界面端口（可选，默认 3000）
PORT=3000
```

保存文件（`Ctrl+O`，然后 `Ctrl+X`）

### 6. 初始化配置文件

项目首次运行会自动创建 `config.json`，但您也可以手动创建：

```bash
cp config.sample.json config.json
```

然后编辑 `config.json` 配置您的账号和频道映射。

### 7. 使用 PM2 管理进程

#### 安装 PM2

在宝塔终端中执行：

```bash
npm install -g pm2
```

#### 创建 PM2 启动脚本

创建 `ecosystem.config.js` 文件：

```bash
cd /www/wwwroot/discord-bot
nano ecosystem.config.js
```

添加以下内容：

```javascript
module.exports = {
  apps: [
    {
      name: 'discord-bot',
      script: './dist-bot/index.js',
      cwd: '/www/wwwroot/discord-bot',
      instances: 1,
      autorestart: true,
      watch: false,
      max_memory_restart: '500M',
      error_file: './logs/pm2-error.log',
      out_file: './logs/pm2-out.log',
      log_date_format: 'YYYY-MM-DD HH:mm:ss',
      env: {
        NODE_ENV: 'production'
      }
    },
    {
      name: 'discord-web',
      script: './dist-server/server.js',
      cwd: '/www/wwwroot/discord-bot',
      instances: 1,
      autorestart: true,
      watch: false,
      max_memory_restart: '200M',
      error_file: './logs/pm2-web-error.log',
      out_file: './logs/pm2-web-out.log',
      log_date_format: 'YYYY-MM-DD HH:mm:ss',
      env: {
        NODE_ENV: 'production',
        PORT: 3000
      }
    }
  ]
};
```

**注意**：请将 `/www/wwwroot/discord-bot` 替换为您的实际项目路径。

#### 启动服务

```bash
# 启动所有服务
pm2 start ecosystem.config.js

# 或者分别启动
pm2 start ecosystem.config.js --only discord-bot    # 只启动 Bot
pm2 start ecosystem.config.js --only discord-web    # 只启动管理界面

# 查看状态
pm2 status

# 查看日志
pm2 logs discord-bot
pm2 logs discord-web

# 停止服务
pm2 stop discord-bot
pm2 stop discord-web

# 重启服务
pm2 restart discord-bot
pm2 restart discord-web
```

#### 设置开机自启

```bash
pm2 startup
pm2 save
```

### 8. 配置宝塔反向代理（可选，用于管理界面）

如果您想通过域名访问管理界面，可以配置反向代理：

1. 在宝塔面板中，进入 **网站** → **添加站点**
2. 创建站点（或使用现有站点）
3. 进入站点设置 → **反向代理** → **添加反向代理**
4. 配置如下：
   - **代理名称**：discord-bot
   - **目标URL**：`http://127.0.0.1:3000`
   - **发送域名**：`$host`
   - **缓存**：关闭
5. 保存配置

### 9. 配置防火墙

如果使用管理界面，需要在宝塔面板中开放端口：

1. 进入 **安全** → **防火墙**
2. 添加规则：
   - **端口**：3000（或您设置的 PORT）
   - **协议**：TCP
   - **策略**：放行
3. 保存

### 10. 验证部署

1. **检查 Bot 是否运行**：
   ```bash
   pm2 logs discord-bot --lines 50
   ```
   应该看到登录成功的消息。

2. **检查管理界面**：
   访问 `http://您的服务器IP:3000` 或配置的域名，应该能看到管理界面。

3. **测试转发功能**：
   在配置的源频道发送消息，检查目标频道是否收到转发。

## 🔧 常用维护命令

```bash
# 进入项目目录
cd /www/wwwroot/discord-bot

# 更新代码后重新编译
pnpm build:bot
pnpm build:server

# 重启服务
pm2 restart discord-bot
pm2 restart discord-web

# 查看实时日志
pm2 logs discord-bot --lines 100

# 查看进程状态
pm2 status

# 停止所有服务
pm2 stop all

# 删除 PM2 进程
pm2 delete discord-bot
pm2 delete discord-web
```

## 📝 注意事项

1. **权限问题**：确保项目目录有读写权限：
   ```bash
   chown -R www:www /www/wwwroot/discord-bot
   chmod -R 755 /www/wwwroot/discord-bot
   ```

2. **日志文件**：日志文件位于 `logs/` 目录，定期清理避免占用过多磁盘空间。

3. **内存限制**：如果服务器内存较小，可以在 `ecosystem.config.js` 中调整 `max_memory_restart` 的值。

4. **配置文件备份**：定期备份 `config.json` 文件，避免配置丢失。

5. **代理配置**：如果服务器无法直接访问 Discord，需要在 `.env` 中配置 `PROXY_URL`。

6. **端口冲突**：如果 3000 端口被占用，可以修改 `.env` 中的 `PORT` 或 `ecosystem.config.js` 中的端口配置。

## 🐛 故障排查

### Bot 无法启动

1. 检查 Token 是否正确配置在 `config.json` 中
2. 查看日志：`pm2 logs discord-bot --lines 100`
3. 检查网络连接和代理配置

### 管理界面无法访问

1. 检查端口是否开放：`netstat -tlnp | grep 3000`
2. 检查 PM2 进程是否运行：`pm2 status`
3. 查看日志：`pm2 logs discord-web --lines 100`

### 消息转发失败

1. 检查 Webhook URL 是否正确
2. 检查频道映射配置
3. 查看 Bot 日志中的错误信息

## 📞 技术支持

如遇到问题，请查看项目日志文件或联系技术支持。

