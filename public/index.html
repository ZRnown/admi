<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Discord Forwarder Config</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 p-4 md:p-8 font-sans">
  <div class="max-w-7xl mx-auto space-y-8">
    <header class="flex flex-col md:flex-row md:items-center justify-between gap-4 pb-6 border-b border-slate-200">
      <div>
        <h1 class="text-2xl md:text-3xl font-bold text-slate-900 tracking-tight">Discord Forwarder Config</h1>
        <p class="text-slate-500 mt-1 text-sm md:text-base">å¯è§†åŒ–é…ç½®ç”Ÿæˆå™¨ Â· è½»æ¾ç®¡ç†è½¬å‘è§„åˆ™</p>
      </div>
      <div class="flex items-center gap-2 text-sm text-slate-500 bg-white px-3 py-1.5 rounded-full border border-slate-200 shadow-sm">
        <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
        æœ¬åœ°è‡ªåŠ¨ä¿å­˜ä¸­
      </div>
    </header>

    <div id="app" style="display: none;">
      <!-- è´¦å·åˆ‡æ¢æ ‡ç­¾ -->
      <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden mb-6">
        <div class="flex flex-col gap-3 border-b border-slate-100 bg-slate-50/60 p-4">
          <div class="flex flex-wrap items-center gap-2" id="accountTabs"></div>
          <div class="flex flex-wrap items-center gap-2">
            <button onclick="showHelp()" class="inline-flex items-center gap-1 rounded-md border border-slate-200 px-3 py-1.5 text-xs font-medium text-slate-600 hover:bg-slate-100">
              <span>â„¹ï¸</span> ä½¿ç”¨è¯´æ˜
            </button>
            <button onclick="exportConfig()" class="inline-flex items-center gap-1 rounded-md border border-indigo-200 px-3 py-1.5 text-xs font-medium text-indigo-600 hover:bg-indigo-50">
              <span>â¬‡ï¸</span> å¯¼å‡ºé…ç½®
            </button>
            <button onclick="removeAccount()" class="inline-flex items-center gap-1 rounded-md border border-red-200 px-3 py-1.5 text-xs font-medium text-red-600 hover:bg-red-50">
              <span>ğŸ—‘ï¸</span> åˆ é™¤å½“å‰è´¦å·
            </button>
          </div>
        </div>
        <div id="helpPanel" class="hidden border-b border-slate-100 bg-slate-50 px-6 py-4 text-sm leading-relaxed text-slate-600">
          <button onclick="hideHelp()" class="float-right text-slate-400 hover:text-slate-600">âœ•</button>
          <p class="font-semibold text-slate-800">ä½¿ç”¨è¯´æ˜</p>
          <ul class="mt-2 list-disc space-y-1 pl-5">
            <li>ä¸€ä¸ªè´¦å·å¯¹åº”ä¸€ä¸ª Discord Tokenï¼Œå¯é€‰æ‹©æœºå™¨äºº Token æˆ–è‡ªç”¨å· Tokenã€‚</li>
            <li>æ¯ä¸ªè´¦å·éƒ½å¯ä»¥å•ç‹¬é…ç½®è½¬å‘è§„åˆ™ã€å…³é”®è¯ã€æ’é™¤/æ›¿æ¢è§„åˆ™ã€‚</li>
            <li>è½¬å‘æ—¶å¦‚éœ€ä¼ªè£…ä¸ºæºç”¨æˆ·ï¼Œè¯·å‹¾é€‰ã€Œä½¿ç”¨æºç”¨æˆ·æ˜µç§°å’Œå¤´åƒã€ã€‚</li>
            <li>æ’é™¤å…³é”®è¯ä¼šç›´æ¥åˆ é™¤å‘½ä¸­çš„è¯ï¼Œè€Œä¸ä¼šé˜»æ­¢æ•´æ¡æ¶ˆæ¯è½¬å‘ã€‚</li>
            <li>å¯ä»¥æ·»åŠ å¤šä¸ªè´¦å·å¹¶è¡Œè¿è¡Œï¼Œåç«¯ä¼šä¸ºæ¯ä¸ªè´¦å·ç‹¬ç«‹ç™»å½•å¹¶è½¬å‘ã€‚</li>
          </ul>
        </div>
      </div>

      <!-- é…ç½®è¡¨å• -->
      <div id="configForm"></div>
    </div>

    <footer class="text-center text-slate-400 text-xs py-8">
      <p>Discord Forwarder Management</p>
    </footer>
  </div>

  <script>
    // å…¼å®¹çš„ ID ç”Ÿæˆå‡½æ•°
    function genId() {
      try {
        if (typeof crypto !== 'undefined' && crypto.randomUUID) {
          return crypto.randomUUID();
        }
        if (typeof globalThis !== 'undefined' && globalThis.crypto && globalThis.crypto.randomUUID) {
          return globalThis.crypto.randomUUID();
        }
      } catch (e) {
        // é™çº§æ–¹æ¡ˆ
      }
      // é™çº§ï¼šä½¿ç”¨æ—¶é—´æˆ³ + éšæœºæ•°
      return `id_${Date.now().toString(36)}_${Math.random().toString(36).slice(2, 8)}`;
    }

    let state = { accounts: [], activeId: "" };
    let saveTimer = null;

    // åˆå§‹åŒ–
    async function init() {
      await loadConfig();
      document.getElementById('app').style.display = 'block';
      render();
      startStatusPolling();
    }

    // åŠ è½½é…ç½®
    async function loadConfig() {
      try {
        const res = await fetch('/api/config');
        const data = await res.json();
        if (Array.isArray(data?.accounts)) {
          state = { accounts: data.accounts, activeId: data.activeId || data.accounts[0]?.id || "" };
        }
      } catch (e) {
        console.error('åŠ è½½é…ç½®å¤±è´¥', e);
      }
    }

    // ä¿å­˜é…ç½®ï¼ˆé˜²æŠ–ï¼‰
    async function saveConfig() {
      if (saveTimer) clearTimeout(saveTimer);
      saveTimer = setTimeout(async () => {
        try {
          await fetch('/api/config', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(state)
          });
        } catch (e) {
          console.error('ä¿å­˜å¤±è´¥', e);
        }
      }, 800);
    }

    // æ¸²æŸ“ç•Œé¢
    function render() {
      if (state.accounts.length === 0) {
        document.getElementById('app').innerHTML = '<div class="text-center py-8 text-slate-400">æš‚æ— è´¦å·ï¼Œè¯·æ·»åŠ </div>';
        return;
      }

      const activeAccount = state.accounts.find(a => a.id === state.activeId) || state.accounts[0];
      
      // æ¸²æŸ“è´¦å·æ ‡ç­¾
      let tabsHtml = state.accounts.map(acc => `
        <button onclick="switchAccount('${acc.id}')" 
          class="rounded-full px-3 py-1 text-sm font-medium transition ${
            acc.id === state.activeId 
              ? 'bg-indigo-600 text-white shadow' 
              : 'bg-white text-slate-600 border border-slate-200 hover:bg-slate-100'
          }">
          ${acc.name || 'æœªå‘½åè´¦å·'}
        </button>
      `).join('');
      tabsHtml += `<button onclick="addAccount()" class="inline-flex items-center gap-1 rounded-full border border-dashed border-indigo-300 px-3 py-1 text-sm font-medium text-indigo-600 hover:bg-indigo-50">+ æ·»åŠ è´¦å·</button>`;
      document.getElementById('accountTabs').innerHTML = tabsHtml;

      // æ¸²æŸ“é…ç½®è¡¨å•
      document.getElementById('configForm').innerHTML = renderAccountForm(activeAccount);
    }

    // æ¸²æŸ“è´¦å·é…ç½®è¡¨å•
    function renderAccountForm(acc) {
      const isPending = acc.loginState === 'pending';
      const isOnline = acc.loginState === 'online';
      
      return `
        <!-- åŸºç¡€è®¾ç½® -->
        <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden mb-6">
          <div class="px-6 py-4 border-b border-slate-100 bg-slate-50/50">
            <h2 class="font-semibold text-slate-800">åŸºç¡€è®¾ç½®</h2>
          </div>
          <div class="p-6 space-y-4">
            <div class="grid gap-4 md:grid-cols-2">
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">è´¦å·åç§°</label>
                <input type="text" value="${acc.name || ''}" onchange="updateField('name', this.value)" 
                  class="w-full rounded-lg border border-slate-200 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none">
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">è´¦å·ç±»å‹</label>
                <select onchange="updateField('type', this.value)" 
                  class="w-full rounded-lg border border-slate-200 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none">
                  <option value="selfbot" ${acc.type === 'selfbot' ? 'selected' : ''}>ç”¨æˆ· Tokenï¼ˆSelfBotï¼‰</option>
                  <option value="bot" ${acc.type === 'bot' ? 'selected' : ''}>æœºå™¨äºº Token</option>
                </select>
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1">Discord Token</label>
              <div class="flex gap-2">
                <input type="password" value="${acc.token || ''}" onchange="updateField('token', this.value)" 
                  placeholder="OT..." class="flex-1 px-3 py-2 border border-slate-200 rounded-lg focus:outline-none font-mono text-sm">
                <button onclick="requestLogin()" ${isPending || isOnline ? 'disabled' : ''} 
                  class="px-3 py-1.5 text-xs font-medium rounded-md ${isPending || isOnline ? 'bg-indigo-300 cursor-not-allowed' : 'bg-indigo-600 hover:bg-indigo-500'} text-white">
                  ${isPending ? 'ç™»å½•ä¸­...' : isOnline ? 'å·²ç™»å½•' : 'ç™»å½•'}
                </button>
                <button onclick="requestStop()" ${isPending || (!isOnline && acc.loginState !== 'error') ? 'disabled' : ''}
                  class="px-3 py-1.5 text-xs font-medium rounded-md border border-slate-200 ${isPending || (!isOnline && acc.loginState !== 'error') ? 'cursor-not-allowed bg-slate-50' : 'hover:bg-slate-100'}">
                  åœæ­¢
                </button>
              </div>
              <div class="text-xs text-slate-500 mt-1">
                çŠ¶æ€: <span class="px-2 py-0.5 rounded-full ${acc.loginState === 'online' ? 'bg-emerald-50 text-emerald-700' : acc.loginState === 'error' ? 'bg-red-50 text-red-700' : 'bg-slate-100 text-slate-600'}">${acc.loginState || 'idle'}</span>
                ${acc.loginMessage ? `<span class="ml-2">${acc.loginMessage}</span>` : ''}
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1">ä»£ç†åœ°å€</label>
              <input type="text" value="${acc.proxyUrl || ''}" onchange="updateField('proxyUrl', this.value)" 
                placeholder="http://127.0.0.1:7890" class="w-full px-3 py-2 border border-slate-200 rounded-lg focus:outline-none font-mono text-sm">
            </div>
            <div class="flex items-center gap-2">
              <input type="checkbox" ${acc.showSourceIdentity ? 'checked' : ''} onchange="updateField('showSourceIdentity', this.checked)" 
                class="h-4 w-4 rounded border-slate-300">
              <label class="text-sm text-slate-700">ä½¿ç”¨æºç”¨æˆ·çš„æ˜µç§°å’Œå¤´åƒè¿›è¡Œè½¬å‘</label>
            </div>
            <div class="border-t pt-4">
              <div class="flex items-center gap-2 mb-2">
                <input type="checkbox" ${acc.enableTranslation ? 'checked' : ''} onchange="updateField('enableTranslation', this.checked)" 
                  class="h-4 w-4 rounded border-slate-300">
                <label class="text-sm text-slate-700">å¯ç”¨è‡ªåŠ¨ç¿»è¯‘ï¼ˆä½¿ç”¨ DeepSeek APIï¼‰</label>
              </div>
              ${acc.enableTranslation ? `
                <div>
                  <label class="block text-sm font-medium text-slate-700 mb-1">DeepSeek API Key</label>
                  <input type="password" value="${acc.deepseekApiKey || ''}" onchange="updateField('deepseekApiKey', this.value)" 
                    placeholder="sk-..." class="w-full px-3 py-2 border border-slate-200 rounded-lg focus:outline-none font-mono text-sm">
                </div>
              ` : ''}
            </div>
          </div>
        </div>

        <!-- è½¬å‘è§„åˆ™ -->
        <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden mb-6">
          <div class="px-6 py-4 border-b border-slate-100 bg-slate-50/50 flex items-center justify-between">
            <h2 class="font-semibold text-slate-800">è½¬å‘è§„åˆ™</h2>
            <button onclick="addMapping()" class="text-xs bg-indigo-50 text-indigo-600 px-2 py-1 rounded-md hover:bg-indigo-100">+ æ·»åŠ è§„åˆ™</button>
          </div>
          <div class="p-6 space-y-4" id="mappingsList">
            ${renderMappings(acc.mappings || [])}
          </div>
        </div>

        <!-- å…³é”®è¯è¿‡æ»¤ -->
        <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden mb-6">
          <div class="px-6 py-4 border-b border-slate-100 bg-slate-50/50">
            <h2 class="font-semibold text-slate-800">å…³é”®è¯è§¦å‘ï¼ˆè‡³å°‘å‘½ä¸­ä¸€ä¸ªæ‰è½¬å‘ï¼‰</h2>
          </div>
          <div class="p-6">
            <div class="flex flex-wrap gap-2 mb-3">
              ${(acc.blockedKeywords || []).map(k => `
                <span class="inline-flex items-center gap-1 px-2.5 py-1 rounded-full bg-red-50 text-red-600 text-sm border border-red-100">
                  ${k} <button onclick="removeKeyword('blockedKeywords', '${k}')" class="hover:text-red-800">âœ•</button>
                </span>
              `).join('')}
              <input type="text" placeholder="è¾“å…¥å…³é”®è¯åå›è½¦..." onkeydown="if(event.key==='Enter') addKeyword('blockedKeywords', this.value); this.value='';" 
                class="flex-1 min-w-[120px] px-3 py-1 border-none focus:outline-none text-sm">
            </div>
          </div>
        </div>

        <!-- æ’é™¤å…³é”®è¯ -->
        <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden mb-6">
          <div class="px-6 py-4 border-b border-slate-100 bg-slate-50/50">
            <h2 class="font-semibold text-slate-800">å±è”½å…³é”®è¯ï¼ˆå‘½ä¸­åˆ™ä¸è½¬å‘ï¼‰</h2>
          </div>
          <div class="p-6">
            <div class="flex flex-wrap gap-2 mb-3">
              ${(acc.excludeKeywords || []).map(k => `
                <span class="inline-flex items-center gap-1 px-2.5 py-1 rounded-full bg-amber-50 text-amber-700 text-sm border border-amber-100">
                  ${k} <button onclick="removeKeyword('excludeKeywords', '${k}')" class="hover:text-amber-900">âœ•</button>
                </span>
              `).join('')}
              <input type="text" placeholder="è¾“å…¥å±è”½è¯åå›è½¦..." onkeydown="if(event.key==='Enter') addKeyword('excludeKeywords', this.value); this.value='';" 
                class="flex-1 min-w-[120px] px-3 py-1 border-none focus:outline-none text-sm">
            </div>
          </div>
        </div>

        <!-- æ›¿æ¢è§„åˆ™ -->
        <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden mb-6">
          <div class="px-6 py-4 border-b border-slate-100 bg-slate-50/50">
            <h2 class="font-semibold text-slate-800">å…³é”®è¯æ›¿æ¢</h2>
          </div>
          <div class="p-6 space-y-2" id="replacementsList">
            ${renderReplacements(acc.replacements || [])}
          </div>
        </div>
      `;
    }

    function renderMappings(mappings) {
      if (mappings.length === 0) {
        return '<div class="text-center py-8 text-slate-400 text-sm">æš‚æ— è½¬å‘è§„åˆ™ï¼Œç‚¹å‡»å³ä¸Šè§’æ·»åŠ </div>';
      }
      return mappings.map((m, idx) => `
        <div class="flex gap-3 items-center p-3 rounded-lg border border-slate-100 bg-slate-50/30">
          <input type="text" value="${m.sourceChannelId || ''}" onchange="updateMapping(${idx}, 'sourceChannelId', this.value)" 
            placeholder="æ¥æºé¢‘é“ ID" class="w-48 px-3 py-2 border border-slate-200 rounded-lg text-sm font-mono">
          <span class="text-slate-300">â†’</span>
          <input type="text" value="${m.targetWebhookUrl || ''}" onchange="updateMapping(${idx}, 'targetWebhookUrl', this.value)" 
            placeholder="ç›®æ ‡ Webhook URL" class="flex-1 px-3 py-2 border border-slate-200 rounded-lg text-sm font-mono">
          <input type="text" value="${m.note || ''}" onchange="updateMapping(${idx}, 'note', this.value)" 
            placeholder="å¤‡æ³¨" class="w-32 px-3 py-1.5 border border-dashed border-slate-200 rounded-lg text-xs">
          <button onclick="removeMapping(${idx})" class="p-2 text-slate-400 hover:text-red-500">ğŸ—‘ï¸</button>
        </div>
      `).join('');
    }

    function renderReplacements(replacements) {
      return replacements.map((r, idx) => `
        <div class="flex gap-2 items-center">
          <input type="text" value="${r.from || ''}" onchange="updateReplacement(${idx}, 'from', this.value)" 
            placeholder="åŸè¯" class="w-40 px-3 py-1.5 border border-slate-200 rounded-lg text-sm font-mono">
          <span class="text-slate-400">â†’</span>
          <input type="text" value="${r.to || ''}" onchange="updateReplacement(${idx}, 'to', this.value)" 
            placeholder="æ›¿æ¢ä¸º" class="flex-1 px-3 py-1.5 border border-slate-200 rounded-lg text-sm font-mono">
          <button onclick="removeReplacement(${idx})" class="p-2 text-slate-400 hover:text-red-500">ğŸ—‘ï¸</button>
        </div>
      `).join('') + '<button onclick="addReplacement()" class="text-xs bg-slate-50 text-slate-700 px-2 py-1 rounded-md hover:bg-slate-100 mt-2">+ æ·»åŠ æ›¿æ¢è§„åˆ™</button>';
    }

    // å·¥å…·å‡½æ•°
    function getActiveAccount() {
      return state.accounts.find(a => a.id === state.activeId) || state.accounts[0];
    }

    function updateField(field, value) {
      const acc = getActiveAccount();
      acc[field] = value;
      saveConfig();
      render();
    }

    function switchAccount(id) {
      state.activeId = id;
      render();
    }

    function addAccount() {
      const newAcc = {
        id: genId(),
        name: `è´¦å·${state.accounts.length + 1}`,
        type: 'selfbot',
        token: '',
        proxyUrl: '',
        loginRequested: false,
        loginState: 'idle',
        showSourceIdentity: false,
        mappings: [],
        blockedKeywords: [],
        excludeKeywords: [],
        replacements: [],
        allowedUsersIds: [],
        mutedUsersIds: [],
        enableTranslation: false,
        deepseekApiKey: ''
      };
      state.accounts.push(newAcc);
      state.activeId = newAcc.id;
      saveConfig();
      render();
    }

    function removeAccount() {
      if (state.accounts.length <= 1) return;
      if (!confirm('ç¡®å®šè¦åˆ é™¤å½“å‰è´¦å·å—ï¼Ÿ')) return;
      state.accounts = state.accounts.filter(a => a.id !== state.activeId);
      state.activeId = state.accounts[0]?.id || '';
      saveConfig();
      render();
    }

    function addMapping() {
      const acc = getActiveAccount();
      if (!acc.mappings) acc.mappings = [];
      acc.mappings.push({ id: genId(), sourceChannelId: '', targetWebhookUrl: '', note: '' });
      saveConfig();
      render();
    }

    function updateMapping(idx, field, value) {
      const acc = getActiveAccount();
      if (acc.mappings[idx]) {
        acc.mappings[idx][field] = value;
        saveConfig();
      }
    }

    function removeMapping(idx) {
      const acc = getActiveAccount();
      acc.mappings.splice(idx, 1);
      saveConfig();
      render();
    }

    function addKeyword(field, value) {
      if (!value.trim()) return;
      const acc = getActiveAccount();
      if (!acc[field]) acc[field] = [];
      if (!acc[field].includes(value.trim())) {
        acc[field].push(value.trim());
        saveConfig();
        render();
      }
    }

    function removeKeyword(field, keyword) {
      const acc = getActiveAccount();
      acc[field] = acc[field].filter(k => k !== keyword);
      saveConfig();
      render();
    }

    function addReplacement() {
      const acc = getActiveAccount();
      if (!acc.replacements) acc.replacements = [];
      acc.replacements.push({ from: '', to: '' });
      saveConfig();
      render();
    }

    function updateReplacement(idx, field, value) {
      const acc = getActiveAccount();
      if (acc.replacements[idx]) {
        acc.replacements[idx][field] = value;
        saveConfig();
      }
    }

    function removeReplacement(idx) {
      const acc = getActiveAccount();
      acc.replacements.splice(idx, 1);
      saveConfig();
      render();
    }

    async function requestLogin() {
      const acc = getActiveAccount();
      if (acc.loginState === 'online' || acc.loginState === 'pending') return;
      
      acc.loginState = 'pending';
      acc.loginMessage = 'æ­£åœ¨ç™»å½•...';
      render();

      try {
        const res = await fetch('/api/account/action', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ accountId: acc.id, action: 'login' })
        });
        const data = await res.json();
        if (!res.ok && data.loginState === 'online') {
          acc.loginState = 'online';
          acc.loginMessage = 'å·²ç™»å½•';
        }
      } catch (e) {
        acc.loginState = 'idle';
        acc.loginMessage = 'ç™»å½•è¯·æ±‚å¤±è´¥';
      }
      render();
    }

    async function requestStop() {
      const acc = getActiveAccount();
      if (acc.loginState === 'pending' || (acc.loginState !== 'online' && acc.loginState !== 'error')) return;
      
      acc.loginState = 'idle';
      acc.loginMessage = 'æ­£åœ¨åœæ­¢...';
      render();

      try {
        const res = await fetch('/api/account/action', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ accountId: acc.id, action: 'stop' })
        });
        const data = await res.json();
        if (res.ok) {
          acc.loginState = data.loginState || 'idle';
          acc.loginMessage = data.loginMessage || 'å·²åœæ­¢';
        }
      } catch (e) {
        acc.loginState = acc.loginState || 'idle';
        acc.loginMessage = 'åœæ­¢è¯·æ±‚å¤±è´¥';
      }
      render();
    }

    function showHelp() {
      document.getElementById('helpPanel').classList.remove('hidden');
    }

    function hideHelp() {
      document.getElementById('helpPanel').classList.add('hidden');
    }

    async function exportConfig() {
      try {
        const res = await fetch('/api/config');
        const data = await res.json();
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `discord-forwarder-config-${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.json`;
        a.click();
        URL.revokeObjectURL(url);
      } catch (e) {
        alert('å¯¼å‡ºå¤±è´¥: ' + e.message);
      }
    }

    // çŠ¶æ€è½®è¯¢
    function startStatusPolling() {
      setInterval(async () => {
        try {
          const res = await fetch('/api/config');
          const data = await res.json();
          if (Array.isArray(data?.accounts)) {
            const hasChange = data.accounts.some((ra, idx) => {
              const la = state.accounts[idx];
              return la && (ra.loginState !== la.loginState || ra.loginMessage !== la.loginMessage);
            });
            if (hasChange) {
              state.accounts.forEach((acc, idx) => {
                const remote = data.accounts[idx];
                if (remote && acc.id === remote.id) {
                  if (acc.loginState !== 'pending' || remote.loginState !== 'idle') {
                    acc.loginState = remote.loginState || acc.loginState;
                    acc.loginMessage = remote.loginMessage || acc.loginMessage;
                  }
                }
              });
              render();
            }
          }
        } catch (e) {
          // å¿½ç•¥è½®è¯¢é”™è¯¯
        }
      }, 2000);
    }

    // å¯åŠ¨
    init();
  </script>
</body>
</html>

