<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Discord Forwarder Config</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 p-4 md:p-8 font-sans">
  <!-- ç™»å½•é¡µé¢ -->
  <div id="loginPage" class="max-w-md mx-auto mt-20">
    <div class="bg-white rounded-xl border border-slate-200 shadow-lg p-8">
      <h1 class="text-2xl font-bold text-slate-900 text-center mb-2">Discord Forwarder Config</h1>
      <p class="text-slate-500 text-center text-sm mb-6">å¯è§†åŒ–é…ç½®ç”Ÿæˆå™¨ Â· è½»æ¾ç®¡ç†è½¬å‘è§„åˆ™</p>
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">ç”¨æˆ·å</label>
          <input type="text" id="loginUsername" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" 
            class="w-full rounded-lg border border-slate-200 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none">
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">å¯†ç </label>
          <input type="password" id="loginPassword" placeholder="è¯·è¾“å…¥å¯†ç " 
            class="w-full rounded-lg border border-slate-200 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none"
            onkeydown="if(event.key==='Enter') handleLogin()">
        </div>
        <div id="loginError" class="hidden text-sm text-red-500 text-center"></div>
        <button onclick="handleLogin()" 
          class="w-full rounded-lg bg-indigo-600 px-4 py-2 text-sm font-medium text-white hover:bg-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
          ç™»å½•
        </button>
      </div>
    </div>
  </div>

  <!-- ä¸»é…ç½®é¡µé¢ -->
  <div id="mainPage" class="max-w-7xl mx-auto space-y-8" style="display: none;">
    <header class="flex flex-col md:flex-row md:items-center justify-between gap-4 pb-6 border-b border-slate-200">
      <div>
        <h1 class="text-2xl md:text-3xl font-bold text-slate-900 tracking-tight">Discord Forwarder Config</h1>
        <p class="text-slate-500 mt-1 text-sm md:text-base">å¯è§†åŒ–é…ç½®ç”Ÿæˆå™¨ Â· è½»æ¾ç®¡ç†è½¬å‘è§„åˆ™</p>
      </div>
      <div class="flex items-center gap-3">
        <button onclick="showChangePasswordModal()" 
          class="inline-flex items-center gap-1 rounded-md border border-slate-200 px-3 py-1.5 text-xs font-medium text-slate-600 hover:bg-slate-100">
          <span>ğŸ”</span> ä¿®æ”¹è´¦å¯†
        </button>
        <button onclick="handleLogout()" 
          class="inline-flex items-center gap-1 rounded-md border border-red-200 px-3 py-1.5 text-xs font-medium text-red-600 hover:bg-red-50">
          <span>ğŸšª</span> é€€å‡ºç™»å½•
        </button>
        <div class="flex items-center gap-2 text-sm text-slate-500 bg-white px-3 py-1.5 rounded-full border border-slate-200 shadow-sm">
          <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
          æœ¬åœ°è‡ªåŠ¨ä¿å­˜ä¸­
        </div>
      </div>
    </header>

    <div id="app" style="display: none;">
      <!-- è´¦å·åˆ‡æ¢æ ‡ç­¾ -->
      <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden mb-6">
        <div class="flex flex-col gap-3 border-b border-slate-100 bg-slate-50/60 p-4">
          <div class="flex flex-wrap items-center gap-2" id="accountTabs"></div>
          <div class="flex flex-wrap items-center gap-2">
            <button onclick="showHelp()" class="inline-flex items-center gap-1 rounded-md border border-slate-200 px-3 py-1.5 text-xs font-medium text-slate-600 hover:bg-slate-100">
              <span>â„¹ï¸</span> ä½¿ç”¨è¯´æ˜
            </button>
            <button onclick="exportConfig()" class="inline-flex items-center gap-1 rounded-md border border-indigo-200 px-3 py-1.5 text-xs font-medium text-indigo-600 hover:bg-indigo-50">
              <span>â¬‡ï¸</span> å¯¼å‡ºé…ç½®
            </button>
            <button onclick="removeAccount()" class="inline-flex items-center gap-1 rounded-md border border-red-200 px-3 py-1.5 text-xs font-medium text-red-600 hover:bg-red-50">
              <span>ğŸ—‘ï¸</span> åˆ é™¤å½“å‰å®ä¾‹
            </button>
          </div>
        </div>
        <div id="helpPanel" class="hidden border-b border-slate-100 bg-slate-50 px-6 py-4 text-sm leading-relaxed text-slate-600">
          <button onclick="hideHelp()" class="float-right text-slate-400 hover:text-slate-600">âœ•</button>
          <p class="font-semibold text-slate-800">ä½¿ç”¨è¯´æ˜</p>
          <ul class="mt-2 list-disc space-y-1 pl-5">
            <li>ä¸€ä¸ªè½¬å‘å®ä¾‹å¯¹åº”ä¸€ä¸ª Discord Tokenï¼Œå¯é€‰æ‹©æœºå™¨äºº Token æˆ–è‡ªç”¨å· Tokenã€‚</li>
            <li>æ¯ä¸ªè½¬å‘å®ä¾‹éƒ½å¯ä»¥å•ç‹¬é…ç½®è½¬å‘è§„åˆ™ã€å…³é”®è¯ã€æ’é™¤/æ›¿æ¢è§„åˆ™ã€‚</li>
            <li>è½¬å‘æ—¶å¦‚éœ€ä¼ªè£…ä¸ºæºç”¨æˆ·ï¼Œè¯·å‹¾é€‰ã€Œä½¿ç”¨æºç”¨æˆ·æ˜µç§°å’Œå¤´åƒã€ã€‚</li>
            <li>æ’é™¤å…³é”®è¯ä¼šç›´æ¥åˆ é™¤å‘½ä¸­çš„è¯ï¼Œè€Œä¸ä¼šé˜»æ­¢æ•´æ¡æ¶ˆæ¯è½¬å‘ã€‚</li>
            <li>å¯ä»¥æ·»åŠ å¤šä¸ªè½¬å‘å®ä¾‹å¹¶è¡Œè¿è¡Œï¼Œåç«¯ä¼šä¸ºæ¯ä¸ªå®ä¾‹ç‹¬ç«‹ç™»å½•å¹¶è½¬å‘ã€‚</li>
            <li class="mt-3 font-semibold text-slate-700">å…³äº Tokenï¼š</li>
            <li class="pl-4">â€¢ æ­¤ Token ä¸ Discord Bot Token ä¸åŒã€‚</li>
            <li class="pl-4">â€¢ æ­¤ Token åœ¨æ‚¨æ›´æ”¹å¯†ç æ—¶ä¼šå‘ç”Ÿå˜åŒ–ã€‚</li>
            <li class="pl-4">â€¢ å¦‚æœå¯ç”¨äº†åŒå› ç´ è®¤è¯ï¼ˆ2FAï¼‰ï¼Œéœ€è¦å…ˆç¦ç”¨å®ƒæ‰èƒ½è·å– Tokenã€‚</li>
          </ul>
        </div>
      </div>

      <!-- é…ç½®è¡¨å• -->
      <div id="configForm"></div>
    </div>

    <footer class="text-center text-slate-400 text-xs py-8">
      <p>Discord Forwarder Management</p>
    </footer>
  </div>

  <!-- ä¿®æ”¹å¯†ç å¼¹çª— -->
  <div id="changePasswordModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="if(event.target === this) closeChangePasswordModal()">
    <div class="bg-white rounded-xl border border-slate-200 shadow-lg p-6 w-full max-w-md mx-4" onclick="event.stopPropagation()">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-bold text-slate-900">ä¿®æ”¹è´¦å¯†</h2>
        <button onclick="closeChangePasswordModal()" class="text-slate-400 hover:text-slate-600">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">ç”¨æˆ·å</label>
          <input type="text" id="newUsername" placeholder="ç•™ç©ºåˆ™ä¸å¯ç”¨ç™»å½•ä¿æŠ¤" 
            class="w-full rounded-lg border border-slate-200 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none">
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">æ–°å¯†ç </label>
          <input type="password" id="newPassword" placeholder="ç•™ç©ºåˆ™ä¸ä¿®æ”¹å¯†ç " 
            class="w-full rounded-lg border border-slate-200 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none">
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">ç¡®è®¤å¯†ç </label>
          <input type="password" id="confirmPassword" placeholder="å†æ¬¡è¾“å…¥æ–°å¯†ç " 
            class="w-full rounded-lg border border-slate-200 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none"
            onkeydown="if(event.key==='Enter') saveNewPassword()">
        </div>
        <div id="passwordError" class="hidden text-sm text-red-500"></div>
        <div class="flex gap-2">
          <button onclick="closeChangePasswordModal()" 
            class="flex-1 rounded-lg border border-slate-200 px-4 py-2 text-sm font-medium text-slate-600 hover:bg-slate-50">
            å–æ¶ˆ
          </button>
          <button onclick="saveNewPassword()" 
            class="flex-1 rounded-lg bg-indigo-600 px-4 py-2 text-sm font-medium text-white hover:bg-indigo-500">
            ä¿å­˜
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // å…¼å®¹çš„ ID ç”Ÿæˆå‡½æ•°
    function genId() {
      try {
        if (typeof crypto !== 'undefined' && crypto.randomUUID) {
          return crypto.randomUUID();
        }
        if (typeof globalThis !== 'undefined' && globalThis.crypto && globalThis.crypto.randomUUID) {
          return globalThis.crypto.randomUUID();
        }
      } catch (e) {
        // é™çº§æ–¹æ¡ˆ
      }
      // é™çº§ï¼šä½¿ç”¨æ—¶é—´æˆ³ + éšæœºæ•°
      return `id_${Date.now().toString(36)}_${Math.random().toString(36).slice(2, 8)}`;
    }

    let state = { accounts: [], activeId: "", loginUser: "", loginPassword: "" };
    let saveTimer = null;
    let isLoggedIn = false;

    // æ£€æŸ¥ç™»å½•çŠ¶æ€
    function checkLoginStatus() {
      const saved = localStorage.getItem('isLoggedIn');
      return saved === 'true';
    }

    // è®¾ç½®ç™»å½•çŠ¶æ€
    function setLoginStatus(loggedIn) {
      isLoggedIn = loggedIn;
      localStorage.setItem('isLoggedIn', loggedIn ? 'true' : 'false');
    }

    // åˆå§‹åŒ–
    async function init() {
      // æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
      if (!checkLoginStatus()) {
        document.getElementById('loginPage').style.display = 'block';
        document.getElementById('mainPage').style.display = 'none';
        return;
      }

      // å·²ç™»å½•ï¼Œæ˜¾ç¤ºä¸»é¡µé¢
      document.getElementById('loginPage').style.display = 'none';
      document.getElementById('mainPage').style.display = 'block';

      try {
        await loadConfig();
        // å¦‚æœæ²¡æœ‰è´¦å·ï¼Œåˆ›å»ºä¸€ä¸ªé»˜è®¤è´¦å·
        if (state.accounts.length === 0) {
          addAccount();
        }
      } catch (e) {
        console.error('åˆå§‹åŒ–å¤±è´¥', e);
        // å³ä½¿åŠ è½½å¤±è´¥ï¼Œä¹Ÿæ˜¾ç¤ºç•Œé¢
        if (state.accounts.length === 0) {
          addAccount();
        }
      } finally {
        document.getElementById('app').style.display = 'block';
        render();
        startStatusPolling();
      }
    }

    // å¤„ç†ç™»å½•
    async function handleLogin() {
      const username = document.getElementById('loginUsername').value.trim();
      const password = document.getElementById('loginPassword').value.trim();
      const errorEl = document.getElementById('loginError');

      if (!username || !password) {
        errorEl.textContent = 'è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ';
        errorEl.classList.remove('hidden');
        return;
      }

      // åŠ è½½é…ç½®ä»¥è·å–æ­£ç¡®çš„è´¦å¯†
      try {
        const res = await fetch('/api/config');
        if (!res.ok) {
          errorEl.textContent = 'æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨';
          errorEl.classList.remove('hidden');
          return;
        }
        const data = await res.json();
        const configUser = data.loginUser || 'admin';
        const configPassword = data.loginPassword || 'admin123';

        // å¦‚æœé…ç½®ä¸­è´¦å¯†ä¸ºç©ºï¼Œä½¿ç”¨é»˜è®¤å€¼
        const expectedUser = configUser || 'admin';
        const expectedPassword = configPassword || 'admin123';

        if (username === expectedUser && password === expectedPassword) {
          setLoginStatus(true);
          errorEl.classList.add('hidden');
          // é‡æ–°åˆå§‹åŒ–ä»¥æ˜¾ç¤ºä¸»é¡µé¢
          await init();
        } else {
          errorEl.textContent = 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯';
          errorEl.classList.remove('hidden');
        }
      } catch (e) {
        console.error('ç™»å½•å¤±è´¥', e);
        errorEl.textContent = 'ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•';
        errorEl.classList.remove('hidden');
      }
    }

    // å¤„ç†é€€å‡ºç™»å½•
    function handleLogout() {
      if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
        setLoginStatus(false);
        document.getElementById('loginPage').style.display = 'block';
        document.getElementById('mainPage').style.display = 'none';
        document.getElementById('app').style.display = 'none';
        document.getElementById('loginUsername').value = '';
        document.getElementById('loginPassword').value = '';
      }
    }

    // æ˜¾ç¤ºä¿®æ”¹å¯†ç å¼¹çª—
    function showChangePasswordModal() {
      const modal = document.getElementById('changePasswordModal');
      if (modal) {
        modal.classList.remove('hidden');
        document.getElementById('newUsername').value = state.loginUser || '';
        document.getElementById('newPassword').value = '';
        document.getElementById('confirmPassword').value = '';
        document.getElementById('passwordError').classList.add('hidden');
      }
    }

    // å…³é—­ä¿®æ”¹å¯†ç å¼¹çª—
    function closeChangePasswordModal() {
      const modal = document.getElementById('changePasswordModal');
      if (modal) {
        modal.classList.add('hidden');
      }
    }

    // ä¿å­˜æ–°å¯†ç 
    async function saveNewPassword() {
      const newUsername = document.getElementById('newUsername').value.trim();
      const newPassword = document.getElementById('newPassword').value.trim();
      const confirmPassword = document.getElementById('confirmPassword').value.trim();
      const errorEl = document.getElementById('passwordError');

      if (!newUsername) {
        errorEl.textContent = 'ç”¨æˆ·åä¸èƒ½ä¸ºç©º';
        errorEl.classList.remove('hidden');
        return;
      }

      if (newPassword && newPassword !== confirmPassword) {
        errorEl.textContent = 'ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´';
        errorEl.classList.remove('hidden');
        return;
      }

      // æ›´æ–°é…ç½®
      state.loginUser = newUsername;
      // å¦‚æœå¯†ç ä¸ºç©ºï¼Œä¿æŒåŸå¯†ç ä¸å˜ï¼›å¦åˆ™æ›´æ–°ä¸ºæ–°å¯†ç 
      if (newPassword) {
        state.loginPassword = newPassword;
      }

      try {
        // æ„å»ºä¿å­˜çš„æ•°æ®
        const saveData = {
          accounts: state.accounts,
          activeId: state.activeId,
          loginUser: state.loginUser
        };
        // åªæœ‰åœ¨æ–°å¯†ç ä¸ä¸ºç©ºæ—¶æ‰æ›´æ–°å¯†ç 
        if (newPassword) {
          saveData.loginPassword = state.loginPassword;
        } else {
          // å¦‚æœå¯†ç ä¸ºç©ºï¼Œä»å½“å‰é…ç½®ä¸­è·å–åŸå¯†ç 
          const res = await fetch('/api/config');
          const data = await res.json();
          saveData.loginPassword = data.loginPassword || state.loginPassword;
        }

        // ç›´æ¥è°ƒç”¨ API ä¿å­˜é…ç½®
        await fetch('/api/config', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(saveData)
        });
        errorEl.classList.add('hidden');
        closeChangePasswordModal();
        if (newPassword) {
          alert('è´¦å¯†ä¿®æ”¹æˆåŠŸï¼è¯·ä½¿ç”¨æ–°è´¦å¯†é‡æ–°ç™»å½•ã€‚');
          handleLogout();
        } else {
          alert('ç”¨æˆ·åä¿®æ”¹æˆåŠŸï¼');
          // é‡æ–°åŠ è½½é…ç½®ä»¥æ›´æ–°æ˜¾ç¤º
          await loadConfig();
        }
      } catch (e) {
        console.error('ä¿å­˜å¤±è´¥', e);
        errorEl.textContent = 'ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•';
        errorEl.classList.remove('hidden');
      }
    }

    // åŠ è½½é…ç½®
    async function loadConfig() {
      try {
        const res = await fetch('/api/config');
        if (!res.ok) {
          console.error('åŠ è½½é…ç½®å¤±è´¥: HTTP', res.status);
          return;
        }
        const data = await res.json();
        console.log('åŠ è½½é…ç½®æˆåŠŸ:', data);
        if (Array.isArray(data?.accounts)) {
          state = {
            accounts: data.accounts,
            activeId: data.activeId || data.accounts[0]?.id || "",
            loginUser: data.loginUser || "",
            loginPassword: data.loginPassword || "",
          };
        } else {
          console.warn('é…ç½®æ•°æ®æ ¼å¼ä¸æ­£ç¡®:', data);
        }
      } catch (e) {
        console.error('åŠ è½½é…ç½®å¤±è´¥', e);
        throw e; // é‡æ–°æŠ›å‡ºé”™è¯¯ï¼Œè®© init å¤„ç†
      }
    }

    // ä¿å­˜é…ç½®ï¼ˆé˜²æŠ–ï¼‰
    async function saveConfig() {
      if (saveTimer) clearTimeout(saveTimer);
      saveTimer = setTimeout(async () => {
        try {
          await fetch('/api/config', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(state)
          });
        } catch (e) {
          console.error('ä¿å­˜å¤±è´¥', e);
        }
      }, 800);
    }

    // æ¸²æŸ“ç•Œé¢
    function render() {
      // ç¡®ä¿ app å…ƒç´ å­˜åœ¨
      const appEl = document.getElementById('app');
      if (!appEl) {
        console.error('æ‰¾ä¸åˆ° app å…ƒç´ ');
        return;
      }

      if (state.accounts.length === 0) {
        // å¦‚æœæ²¡æœ‰è´¦å·ï¼Œæ˜¾ç¤ºæç¤ºå’Œæ·»åŠ æŒ‰é’®
        appEl.innerHTML = `
          <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-8 text-center">
            <p class="text-slate-400 mb-4">æš‚æ— è½¬å‘å®ä¾‹</p>
            <button onclick="addAccount(); render();" class="inline-flex items-center gap-1 rounded-md bg-indigo-600 px-4 py-2 text-sm font-medium text-white hover:bg-indigo-500">
              + æ·»åŠ è½¬å‘å®ä¾‹
            </button>
          </div>
        `;
        return;
      }

      const activeAccount = state.accounts.find(a => a.id === state.activeId) || state.accounts[0];
      
      // æ¸²æŸ“è´¦å·æ ‡ç­¾
      // æ¸²æŸ“è´¦å·æ ‡ç­¾
      const accountTabsEl = document.getElementById('accountTabs');
      const configFormEl = document.getElementById('configForm');
      
      if (!accountTabsEl || !configFormEl) {
        console.error('æ‰¾ä¸åˆ°å¿…è¦çš„ DOM å…ƒç´ ');
        return;
      }

      let tabsHtml = state.accounts.map(acc => `
        <button onclick="switchAccount('${acc.id}')" 
          class="rounded-full px-3 py-1 text-sm font-medium transition ${
            acc.id === state.activeId 
              ? 'bg-indigo-600 text-white shadow' 
              : 'bg-white text-slate-600 border border-slate-200 hover:bg-slate-100'
          }">
          ${acc.name || 'æœªå‘½åè´¦å·'}
        </button>
      `).join('');
      tabsHtml += `<button onclick="addAccount(); render();" class="inline-flex items-center gap-1 rounded-full border border-dashed border-indigo-300 px-3 py-1 text-sm font-medium text-indigo-600 hover:bg-indigo-50">+ æ·»åŠ è½¬å‘å®ä¾‹</button>`;
      accountTabsEl.innerHTML = tabsHtml;

      // æ¸²æŸ“é…ç½®è¡¨å•
      configFormEl.innerHTML = renderAccountForm(activeAccount);
    }

    // æ¸²æŸ“è´¦å·é…ç½®è¡¨å•
    function renderAccountForm(acc) {
      const isPending = acc.loginState === 'pending';
      const isOnline = acc.loginState === 'online';
      
      return `
        <!-- åŸºç¡€è®¾ç½® -->
        <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden mb-4">
          <div class="px-6 py-4 border-b border-slate-100 bg-slate-50/50">
            <h2 class="font-semibold text-slate-800">åŸºç¡€è®¾ç½®</h2>
            <p class="mt-1 text-xs text-slate-500 space-y-1">
              <span class="block">1ï¼‰å…ˆåœ¨ä¸‹æ–¹â€œDiscord è½¬å‘è§„åˆ™â€ä¸­é…ç½®æ¥æºé¢‘é“å’Œç›®æ ‡ Discord Webhookã€‚</span>
              <span class="block">2ï¼‰å¦‚éœ€åŒæ­¥åˆ°é£ä¹¦ï¼Œåœ¨â€œé£ä¹¦è½¬å‘è§„åˆ™â€ä¸­ä¸ºç›¸åŒæ¥æºé¢‘é“å¡«å†™å¯¹åº”ç¾¤çš„ Chat IDï¼ˆoc_ å¼€å¤´ï¼‰ã€‚</span>
              <span class="block">3ï¼‰ä½¿ç”¨é£ä¹¦å‰ï¼Œè¯·åœ¨é£ä¹¦å¼€å‘è€…åå°åˆ›å»ºä¼ä¸šè‡ªå»ºåº”ç”¨ï¼Œå¼€é€š <code class="px-1 bg-slate-100 rounded">im:resource:upload</code> å’Œ <code class="px-1 bg-slate-100 rounded">im:message:send_as_bot</code> æƒé™ï¼Œå‘å¸ƒåº”ç”¨ç‰ˆæœ¬ï¼Œå¹¶å°†æœºå™¨äººæ‹‰å…¥ç›®æ ‡ç¾¤ã€‚</span>
              <span class="block">4ï¼‰åœ¨é¡¹ç›®æ ¹ç›®å½•çš„ <code class="px-1 bg-slate-100 rounded">.env</code> ä¸­é…ç½® <code class="px-1 bg-slate-100 rounded">FEISHU_APP_ID</code> å’Œ <code class="px-1 bg-slate-100 rounded">FEISHU_APP_SECRET</code>ï¼Œç„¶åé‡å¯ Botã€‚</span>
            </p>
          </div>
          <div class="p-6 space-y-4">
            <div class="grid gap-4 md:grid-cols-2">
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1">å®ä¾‹åç§°</label>
              <input type="text" value="${acc.name || ''}" onchange="updateField('name', this.value)" 
                class="w-full rounded-lg border border-slate-200 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none">
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1">è´¦å·ç±»å‹</label>
              <select onchange="updateField('type', this.value)" 
                class="w-full rounded-lg border border-slate-200 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none">
                <option value="selfbot" ${acc.type === 'selfbot' ? 'selected' : ''}>ğŸ’¬ ç”¨æˆ· Tokenï¼ˆSelfBotï¼‰</option>
                <option value="bot" ${acc.type === 'bot' ? 'selected' : ''}>ğŸ¤– æœºå™¨äºº Token</option>
              </select>
            </div>
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1">Discord Token</label>
              <div class="flex gap-2">
                <input type="password" value="${acc.token || ''}" onchange="updateField('token', this.value)" 
                  placeholder="OT..." class="flex-1 px-3 py-2 border border-slate-200 rounded-lg focus:outline-none font-mono text-sm">
                <button onclick="requestLogin()" ${isPending || isOnline ? 'disabled' : ''} 
                  class="px-3 py-1.5 text-xs font-medium rounded-md ${isPending || isOnline ? 'bg-indigo-300 cursor-not-allowed' : 'bg-indigo-600 hover:bg-indigo-500'} text-white">
                  ${isPending ? 'ç™»å½•ä¸­...' : isOnline ? 'å·²ç™»å½•' : 'ç™»å½•'}
                </button>
                <button onclick="requestStop()" ${isPending || (!isOnline && acc.loginState !== 'error') ? 'disabled' : ''}
                  class="px-3 py-1.5 text-xs font-medium rounded-md border border-slate-200 ${isPending || (!isOnline && acc.loginState !== 'error') ? 'cursor-not-allowed bg-slate-50' : 'hover:bg-slate-100'}">
                  åœæ­¢
                </button>
              </div>
              <div class="text-xs text-slate-500 mt-1">
                çŠ¶æ€: <span class="px-2 py-0.5 rounded-full ${acc.loginState === 'online' ? 'bg-emerald-50 text-emerald-700' : acc.loginState === 'error' ? 'bg-red-50 text-red-700' : 'bg-slate-100 text-slate-600'}">${acc.loginState || 'idle'}</span>
                ${acc.loginMessage ? `<span class="ml-2">${acc.loginMessage}</span>` : ''}
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1">ä»£ç†åœ°å€</label>
              <input type="text" value="${acc.proxyUrl || ''}" onchange="updateField('proxyUrl', this.value)" 
                placeholder="http://127.0.0.1:7890" class="w-full px-3 py-2 border border-slate-200 rounded-lg focus:outline-none font-mono text-sm">
            </div>
            <div class="flex items-center gap-2">
              <input type="checkbox" ${acc.showSourceIdentity ? 'checked' : ''} onchange="updateField('showSourceIdentity', this.checked)" 
                class="h-4 w-4 rounded border-slate-300">
              <label class="text-sm text-slate-700">ä½¿ç”¨æºç”¨æˆ·çš„æ˜µç§°å’Œå¤´åƒè¿›è¡Œè½¬å‘</label>
            </div>
            <div class="border-t pt-4 space-y-3">
              <div class="flex items-center gap-2 mb-2">
                <input type="checkbox" ${acc.enableBotRelay ? 'checked' : ''} ${acc.type === 'bot' ? 'disabled' : ''} onchange="updateField('enableBotRelay', this.checked)" 
                  class="h-4 w-4 rounded border-slate-300 ${acc.type === 'bot' ? 'opacity-50 cursor-not-allowed' : ''}">
                <label class="text-sm text-slate-700 ${acc.type === 'bot' ? 'text-slate-400' : ''}">æœºå™¨äººä¸­è½¬ï¼ˆå¯ä¸ºä¸åŒè§„åˆ™ç»‘å®šä¸åŒçš„ä¸­è½¬æœºå™¨äººï¼‰${acc.type === 'bot' ? 'ï¼ˆæœºå™¨äººè´¦å·ç±»å‹ä¸æ”¯æŒï¼‰' : ''}</label>
              </div>
              ${acc.enableBotRelay && acc.type !== 'bot' ? renderBotRelaySection(acc) : ''}
              <div class="flex items-center gap-2 mb-2">
                <input type="checkbox" ${acc.enableTranslation ? 'checked' : ''} onchange="updateField('enableTranslation', this.checked)" 
                  class="h-4 w-4 rounded border-slate-300">
                <label class="text-sm text-slate-700">å¯ç”¨è‡ªåŠ¨ç¿»è¯‘</label>
              </div>
              ${acc.enableTranslation ? `
                <div class="mb-2">
                  <label class="block text-sm font-medium text-slate-700 mb-1">ç¿»è¯‘æœåŠ¡</label>
                  <select onchange="updateField('translationProvider', this.value)" 
                    class="w-full rounded-lg border border-slate-200 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none">
                    <option value="deepseek" ${acc.translationProvider === 'deepseek' || !acc.translationProvider ? 'selected' : ''}>DeepSeek AI</option>
                    <option value="google" ${acc.translationProvider === 'google' ? 'selected' : ''}>Google ç¿»è¯‘</option>
                    <option value="baidu" ${acc.translationProvider === 'baidu' ? 'selected' : ''}>ç™¾åº¦ç¿»è¯‘</option>
                    <option value="youdao" ${acc.translationProvider === 'youdao' ? 'selected' : ''}>æœ‰é“æ™ºäº‘ç¿»è¯‘</option>
                    <option value="openai" ${acc.translationProvider === 'openai' ? 'selected' : ''}>OpenAI</option>
                  </select>
                </div>
                <div>
                  <label class="block text-sm font-medium text-slate-700 mb-1">API Key / App ID</label>
                  <input type="password" value="${acc.translationApiKey || acc.deepseekApiKey || ''}" onchange="updateField('translationApiKey', this.value)" 
                    placeholder="æ ¹æ®é€‰æ‹©çš„ç¿»è¯‘æœåŠ¡å¡«å†™å¯¹åº”çš„ API Key" class="w-full px-3 py-2 border border-slate-200 rounded-lg focus:outline-none font-mono text-sm">
                </div>
                ${acc.translationProvider === 'baidu' || acc.translationProvider === 'youdao' ? `
                  <div class="mt-2">
                    <label class="block text-sm font-medium text-slate-700 mb-1">App Secret / Secret Key</label>
                    <input type="password" value="${acc.translationSecret || ''}" onchange="updateField('translationSecret', this.value)" 
                      placeholder="ç™¾åº¦/æœ‰é“æ™ºäº‘ç¿»è¯‘éœ€è¦å¡«å†™ Secret Key" class="w-full px-3 py-2 border border-slate-200 rounded-lg focus:outline-none font-mono text-sm">
                  </div>
                ` : ''}
              ` : ''}
            </div>
          </div>
        </div>

        <!-- å¿½ç•¥é€‰é¡¹ -->
        <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden mb-4">
          <div class="px-6 py-4 border-b border-slate-100 bg-slate-50/50">
            <h2 class="font-semibold text-slate-800">å¿½ç•¥é€‰é¡¹</h2>
            <p class="text-xs text-slate-500 mt-1">é€‰æ‹©æ‚¨æƒ³è¦å¿½ç•¥çš„é¡¹ç›®</p>
          </div>
          <div class="p-6">
            <div class="flex flex-wrap items-center gap-4">
              <label class="inline-flex items-center gap-2 text-sm text-slate-700">
              <input type="checkbox" ${acc.ignoreSelf ? 'checked' : ''} onchange="updateField('ignoreSelf', this.checked)" 
                class="h-4 w-4 rounded border-slate-300"> å¿½ç•¥è‡ªå·±çš„æ¶ˆæ¯
              </label>
              <label class="inline-flex items-center gap-2 text-sm text-slate-700">
              <input type="checkbox" ${acc.ignoreBot ? 'checked' : ''} onchange="updateField('ignoreBot', this.checked)" 
                class="h-4 w-4 rounded border-slate-300"> å¿½ç•¥æœºå™¨äººæ¶ˆæ¯
              </label>
              <label class="inline-flex items-center gap-2 text-sm text-slate-700">
              <input type="checkbox" ${acc.ignoreImages ? 'checked' : ''} onchange="updateField('ignoreImages', this.checked)" 
                class="h-4 w-4 rounded border-slate-300"> å¿½ç•¥å›¾ç‰‡
              </label>
              <label class="inline-flex items-center gap-2 text-sm text-slate-700">
              <input type="checkbox" ${acc.ignoreAudio ? 'checked' : ''} onchange="updateField('ignoreAudio', this.checked)" 
                class="h-4 w-4 rounded border-slate-300"> å¿½ç•¥éŸ³é¢‘
              </label>
              <label class="inline-flex items-center gap-2 text-sm text-slate-700">
              <input type="checkbox" ${acc.ignoreVideo ? 'checked' : ''} onchange="updateField('ignoreVideo', this.checked)" 
                class="h-4 w-4 rounded border-slate-300"> å¿½ç•¥è§†é¢‘
              </label>
              <label class="inline-flex items-center gap-2 text-sm text-slate-700">
              <input type="checkbox" ${acc.ignoreDocuments ? 'checked' : ''} onchange="updateField('ignoreDocuments', this.checked)" 
                class="h-4 w-4 rounded border-slate-300"> å¿½ç•¥æ–‡æ¡£
              </label>
            </div>
          </div>
        </div>

        <!-- è½¬å‘è§„åˆ™ -->
        <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden mb-4">
          <div class="px-6 py-4 border-b border-slate-100 bg-slate-50/50">
            <h2 class="font-semibold text-slate-800">è½¬å‘è§„åˆ™</h2>
          </div>
          <div class="p-6 space-y-6" id="mappingsList">
            <div class="flex flex-wrap items-center gap-2 mb-2">
              <span class="text-xs text-slate-500">Discord è½¬å‘æ ·å¼ï¼š</span>
              <select onchange="updateField('feishuStyle', this.value)" 
                class="rounded border border-slate-200 px-2 py-1 text-xs focus:border-indigo-500 focus:outline-none bg-white">
                <option value="style1" ${acc.feishuStyle === 'style2' ? '' : 'selected'}>æ ·å¼1ï¼šå†…åµŒ</option>
                <option value="style2" ${acc.feishuStyle === 'style2' ? 'selected' : ''}>æ ·å¼2ï¼šæ–‡æœ¬+æ—¶é—´</option>
              </select>
            </div>
            <div class="space-y-3 ${acc.enableDiscordForward !== false ? '' : 'opacity-60'}">
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-2">
                  <input type="checkbox" ${acc.enableDiscordForward !== false ? 'checked' : ''} onchange="updateField('enableDiscordForward', this.checked)" class="h-4 w-4 rounded border-slate-300">
                  <span class="text-sm text-slate-800 font-medium">Discord è½¬å‘è§„åˆ™</span>
                </div>
                ${acc.enableDiscordForward !== false ? `<button onclick="addMapping()" class="text-xs bg-indigo-50 text-indigo-600 px-3 py-1.5 rounded-md hover:bg-indigo-100">+ æ·»åŠ è§„åˆ™</button>` : ''}
              </div>
              ${acc.enableDiscordForward !== false ? renderMappings(acc) : '<div class="text-slate-400 text-sm">å·²å…³é—­ Discord è½¬å‘</div>'}
            </div>
            <div class="border-t pt-4 space-y-3 ${acc.enableFeishuForward ? '' : 'opacity-60'}">
              <div class="flex items-center justify-between">
                <div class="flex flex-wrap items-center gap-2">
                  <input type="checkbox" ${acc.enableFeishuForward ? 'checked' : ''} onchange="updateField('enableFeishuForward', this.checked)" class="h-4 w-4 rounded border-slate-300">
                  <span class="text-sm text-slate-800 font-medium">é£ä¹¦è½¬å‘è§„åˆ™</span>
                  <button type="button" onclick="toggleFeishuHelp()" class="text-xs px-2 py-0.5 rounded border border-slate-200 text-slate-500 hover:bg-slate-50">æŸ¥çœ‹é£ä¹¦é…ç½®è¯´æ˜</button>
                  <button type="button" onclick="fetchFeishuChats()" class="text-xs px-2 py-0.5 rounded border border-slate-200 text-slate-500 hover:bg-slate-50">è·å–ç¾¤åˆ—è¡¨</button>
                </div>
                ${acc.enableFeishuForward ? `<button onclick="addFeishuMapping()" class="text-xs bg-indigo-50 text-indigo-600 px-3 py-1.5 rounded-md hover:bg-indigo-100">+ æ·»åŠ è§„åˆ™</button>` : ''}
              </div>
              <div id="feishuHelp" class="hidden text-xs text-slate-500 bg-slate-50 border border-dashed border-slate-200 rounded-md p-3 space-y-1">
                <p>1ï¼‰åœ¨é£ä¹¦å¼€å‘è€…åå°åˆ›å»ºä¼ä¸šè‡ªå»ºåº”ç”¨ï¼Œå¼€é€š <code class="px-1 bg-slate-100 rounded">im:resource:upload</code> å’Œ <code class="px-1 bg-slate-100 rounded">im:message:send_as_bot</code> æƒé™ï¼Œå¹¶å‘å¸ƒç‰ˆæœ¬ã€‚</p>
                <p>2ï¼‰å°†è¯¥åº”ç”¨çš„æœºå™¨äººæ‹‰å…¥ç›®æ ‡ç¾¤ï¼Œåœ¨æ¡Œé¢ç«¯å¼€å¯è°ƒè¯•æ¨¡å¼åï¼Œå³é”®ç¾¤èŠ-&gt;å¤åˆ¶ ID-&gt;å¤åˆ¶ Chat IDï¼ˆä»¥ <code class="px-1 bg-slate-100 rounded">oc_</code> å¼€å¤´ï¼‰ã€‚</p>
                <p>3ï¼‰åœ¨ä¸‹æ–¹â€œé£ä¹¦ Chat IDï¼ˆoc_å¼€å¤´ï¼‰â€ä¸­ä¸ºå¯¹åº”æ¥æºé¢‘é“å¡«å†™ Chat IDã€‚</p>
                <p>4ï¼‰åœ¨æ­¤å¤„å¡«å†™é£ä¹¦åº”ç”¨çš„ AppID ä¸ Secretï¼ˆæˆ–åœ¨é¡¹ç›® <code class="px-1 bg-slate-100 rounded">.env</code> ä¸­é…ç½® <code class="px-1 bg-slate-100 rounded">FEISHU_APP_ID</code> / <code class="px-1 bg-slate-100 rounded">FEISHU_APP_SECRET</code>ï¼‰ã€‚</p>
              </div>
              ${acc.enableFeishuForward ? `
                <div class="grid gap-3 md:grid-cols-2 items-end">
                  <div>
                    <label class="block text-xs font-medium text-slate-600 mb-1">é£ä¹¦ App ID</label>
                    <input type="text" value="${acc.feishuAppId || ''}" onchange="updateField('feishuAppId', this.value)" 
                      placeholder="cli_xxx" class="w-full px-3 py-2 border border-slate-200 rounded-lg text-xs font-mono">
                  </div>
                  <div>
                    <label class="block text-xs font-medium text-slate-600 mb-1">é£ä¹¦ App Secret</label>
                    <input type="password" value="${acc.feishuAppSecret || ''}" onchange="updateField('feishuAppSecret', this.value)" 
                      placeholder="åº”ç”¨å¯†é’¥ï¼Œå»ºè®®å‹¿æ³„éœ²" class="w-full px-3 py-2 border border-slate-200 rounded-lg text-xs font-mono">
                  </div>
                </div>
                <div id="feishuChats" class="mt-2 text-xs text-slate-500"></div>
                ${renderFeishuMappings(acc)}
              ` : '<div class="text-slate-400 text-sm">æœªå¯ç”¨é£ä¹¦è½¬å‘</div>'}
            </div>
          </div>
        </div>

        <!-- å…³é”®è¯è¿‡æ»¤ -->
        <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden mb-4">
          <div class="px-6 py-4 border-b border-slate-100 bg-slate-50/50">
            <h2 class="font-semibold text-slate-800">å…³é”®è¯è§¦å‘ï¼ˆè‡³å°‘å‘½ä¸­ä¸€ä¸ªæ‰è½¬å‘ï¼‰</h2>
          </div>
          <div class="p-6">
            <div class="flex flex-wrap gap-2 mb-3">
              ${(acc.blockedKeywords || []).map(k => `
                <span class="inline-flex items-center gap-1 px-2.5 py-1 rounded-full bg-red-50 text-red-600 text-sm border border-red-100">
                  ${k} <button onclick="removeKeyword('blockedKeywords', '${k}')" class="hover:text-red-800">âœ•</button>
                </span>
              `).join('')}
              <input type="text" placeholder="è¾“å…¥å…³é”®è¯åå›è½¦..." onkeydown="if(event.key==='Enter') addKeyword('blockedKeywords', this.value); this.value='';" 
                class="flex-1 min-w-[120px] px-3 py-1 border-none focus:outline-none text-sm">
            </div>
          </div>
        </div>

        <!-- æ’é™¤å…³é”®è¯ -->
        <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden mb-4">
          <div class="px-6 py-4 border-b border-slate-100 bg-slate-50/50">
            <h2 class="font-semibold text-slate-800">å±è”½å…³é”®è¯ï¼ˆå‘½ä¸­åˆ™ä¸è½¬å‘ï¼‰</h2>
          </div>
          <div class="p-6">
            <div class="flex flex-wrap gap-2 mb-3">
              ${(acc.excludeKeywords || []).map(k => `
                <span class="inline-flex items-center gap-1 px-2.5 py-1 rounded-full bg-amber-50 text-amber-700 text-sm border border-amber-100">
                  ${k} <button onclick="removeKeyword('excludeKeywords', '${k}')" class="hover:text-amber-900">âœ•</button>
                </span>
              `).join('')}
              <input type="text" placeholder="è¾“å…¥å±è”½è¯åå›è½¦..." onkeydown="if(event.key==='Enter') addKeyword('excludeKeywords', this.value); this.value='';" 
                class="flex-1 min-w-[120px] px-3 py-1 border-none focus:outline-none text-sm">
            </div>
          </div>
        </div>

        <!-- æ›¿æ¢è§„åˆ™ -->
        <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden mb-4">
          <div class="px-6 py-4 border-b border-slate-100 bg-slate-50/50">
            <h2 class="font-semibold text-slate-800">å…³é”®è¯æ›¿æ¢</h2>
          </div>
          <div class="p-6 space-y-2" id="replacementsList">
            ${renderReplacements(acc.replacements || [])}
          </div>
        </div>
      `;
    }

    function updateGlobal(field, value) {
      if (!state) return;
      state[field] = value;
      saveConfig();
    }

    function renderMappings(acc) {
      const mappings = acc.mappings || [];
      if (mappings.length === 0) {
        return '<div class="text-center py-8 text-slate-400 text-sm">æš‚æ—  Discord è§„åˆ™ï¼Œç‚¹å‡»â€œæ·»åŠ è§„åˆ™â€åˆ›å»º</div>';
      }
      return mappings.map((m, idx) => `
        <div class="flex flex-col gap-2 p-3 rounded-lg border border-slate-100 bg-slate-50/30">
          <div class="flex gap-3 items-center flex-wrap">
            <input type="text" value="${m.sourceChannelId || ''}" onchange="updateMapping(${idx}, 'sourceChannelId', this.value)" 
              placeholder="æ¥æºé¢‘é“ ID" class="w-48 px-3 py-2 border border-slate-200 rounded-lg text-sm font-mono">
            <span class="text-slate-300">â†’</span>
            <input type="text" value="${m.targetWebhookUrl || ''}" onchange="updateMapping(${idx}, 'targetWebhookUrl', this.value)" 
              placeholder="Discord Webhook URL" class="flex-1 px-3 py-2 border border-slate-200 rounded-lg text-sm font-mono">
            <select onchange="updateMappingRelay(${idx}, this.value)" class="w-44 px-3 py-2 rounded-lg border border-slate-200 text-sm focus:border-indigo-500 focus:outline-none">
              <option value="">Webhook é»˜è®¤</option>
              ${(acc.botRelays || []).map(r => `<option value="${r.id}" ${acc.channelRelayMap?.[m.sourceChannelId || ''] === r.id ? 'selected' : ''}>ğŸ¤– ${r.name || 'ä¸­è½¬æœºå™¨äºº'}</option>`).join('')}
            </select>
            <input type="text" value="${m.note || ''}" onchange="updateMapping(${idx}, 'note', this.value)" 
              placeholder="å¤‡æ³¨" class="w-32 px-3 py-1.5 border border-dashed border-slate-200 rounded-lg text-xs">
            <select onchange="updateMapping(${idx}, 'translateDirection', this.value)" 
              ${!acc.enableTranslation ? 'disabled' : ''} 
              class="px-2 py-1 rounded border border-slate-200 text-xs focus:border-indigo-500 focus:outline-none ${!acc.enableTranslation ? 'opacity-50 cursor-not-allowed' : ''}">
              <option value="off" ${(!acc.enableTranslation || m.translateDirection === 'off' || (!m.translateDirection && !acc.enableTranslation)) ? 'selected' : ''}>å…³é—­ç¿»è¯‘</option>
              <option value="auto" ${(acc.enableTranslation && (m.translateDirection === 'auto' || (!m.translateDirection && acc.enableTranslation))) ? 'selected' : ''}>è‡ªåŠ¨æ£€æµ‹</option>
              <option value="zh-en" ${m.translateDirection === 'zh-en' ? 'selected' : ''}>ä¸­ â†’ è‹±</option>
              <option value="en-zh" ${m.translateDirection === 'en-zh' ? 'selected' : ''}>è‹± â†’ ä¸­</option>
            </select>
            <button onclick="removeMapping(${idx})" class="p-2 text-slate-400 hover:text-red-500">ğŸ—‘ï¸</button>
          </div>
        </div>
      `).join('');
    }

    function renderFeishuMappings(acc) {
      const entries = getFeishuMappings(acc);
      if (entries.length === 0) {
        return '<div class="text-center py-8 text-slate-400 text-sm">æš‚æ— é£ä¹¦è§„åˆ™ï¼Œç‚¹å‡»â€œæ·»åŠ è§„åˆ™â€åˆ›å»º</div>';
      }
      return entries.map((m, idx) => `
        <div class="flex flex-col gap-2 p-3 rounded-lg border border-slate-100 bg-slate-50/30">
          <div class="flex gap-3 items-center">
            <input type="text" value="${m.sourceChannelId || ''}" onchange="updateFeishuSource(${idx}, this.value)" 
              placeholder="æ¥æºé¢‘é“ ID" class="w-48 px-3 py-2 border border-slate-200 rounded-lg text-sm font-mono">
            <span class="text-slate-300">â†’</span>
            <input type="text" value="${m.feishuWebhook || ''}" onchange="updateFeishuWebhookEntry(${idx}, this.value)" 
              placeholder="é£ä¹¦ Chat IDï¼ˆoc_å¼€å¤´ï¼‰" class="flex-1 px-3 py-2 border border-slate-200 rounded-lg text-sm font-mono">
            <input type="text" value="${m.note || ''}" onchange="updateFeishuNote(${idx}, this.value)" 
              placeholder="å¤‡æ³¨" class="w-32 px-3 py-1.5 border border-dashed border-slate-200 rounded-lg text-xs">
            <button onclick="removeFeishuMapping(${idx})" class="p-2 text-slate-400 hover:text-red-500">ğŸ—‘ï¸</button>
          </div>
        </div>
      `).join('');
    }

    function getFeishuMappings(acc) {
      const hooks = acc.channelFeishuWebhooks || {};
      const notes = acc.channelNotes || {};
      return Object.entries(hooks).map(([source, hook]) => ({
        sourceChannelId: source,
        feishuWebhook: hook,
        note: notes[source] || ''
      }));
    }

    function toggleFeishuHelp() {
      const el = document.getElementById('feishuHelp');
      if (!el) return;
      el.classList.toggle('hidden');
    }

    async function fetchFeishuChats() {
      const acc = getActiveAccount();
      if (!acc.id) return;
      const container = document.getElementById('feishuChats');
      if (container) {
        container.innerHTML = '<div class="text-xs text-slate-500">æ­£åœ¨ä»é£ä¹¦è·å–ç¾¤åˆ—è¡¨...</div>';
      }
      try {
        const res = await fetch('/api/feishu/chats', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ accountId: acc.id }),
        });
        const data = await res.json();
        if (!res.ok) {
          throw new Error(data?.error || `è¯·æ±‚å¤±è´¥(${res.status})`);
        }
        const items = Array.isArray(data.items) ? data.items : [];
        if (container) {
          if (items.length === 0) {
            container.innerHTML = '<div class="text-xs text-slate-500">æœªè·å–åˆ°ä»»ä½•ç¾¤ï¼Œè¯·ç¡®è®¤æœºå™¨äººå·²è¢«æ‹‰å…¥ç¾¤å¹¶å…·æœ‰æƒé™ã€‚</div>';
          } else {
            container.innerHTML = `
              <div class="mt-2 max-h-40 overflow-auto rounded border border-slate-200 bg-slate-50/60 p-2 text-xs text-slate-700 space-y-1">
                ${items
                  .map(
                    (it) => `
                  <div class="flex items-center justify-between gap-2">
                    <div class="min-w-0">
                      <div class="truncate font-medium">${it.name || 'æœªå‘½åç¾¤'}</div>
                      <div class="truncate font-mono text-[11px] text-slate-500">${it.chat_id || ''}</div>
                    </div>
                    <button type="button" onclick="navigator.clipboard && navigator.clipboard.writeText('${it.chat_id || ''}')" class="shrink-0 px-2 py-0.5 rounded border border-slate-200 text-[11px] text-slate-600 hover:bg-slate-100">å¤åˆ¶</button>
                  </div>
                `,
                  )
                  .join('')}
              </div>
              <div class="mt-1 text-[11px] text-slate-400">
                æç¤ºï¼šå°†ä¸Šæ–¹ Chat IDï¼ˆ<code class="px-1 bg-slate-100 rounded">oc_...</code>ï¼‰ç²˜è´´åˆ°å¯¹åº”è§„åˆ™çš„â€œé£ä¹¦ Chat IDâ€ä¸­ã€‚
                <a href="https://open.feishu.cn/" target="_blank" rel="noreferrer" class="ml-1 text-indigo-500 hover:underline">æ‰“å¼€é£ä¹¦å¼€æ”¾å¹³å°</a>
              </div>
            `;
          }
        }
      } catch (e) {
        if (container) {
          var msg = (e && e.message) ? e.message : e;
          container.innerHTML = '<div class="text-xs text-red-500">è·å–å¤±è´¥ï¼š' + msg + '</div>';
        }
      }
    }

    function renderReplacements(replacements) {
      return replacements.map((r, idx) => `
        <div class="flex gap-2 items-center">
          <input type="text" value="${r.from || ''}" onchange="updateReplacement(${idx}, 'from', this.value)" 
            placeholder="åŸè¯" class="w-40 px-3 py-1.5 border border-slate-200 rounded-lg text-sm font-mono">
          <span class="text-slate-400">â†’</span>
          <input type="text" value="${r.to || ''}" onchange="updateReplacement(${idx}, 'to', this.value)" 
            placeholder="æ›¿æ¢ä¸º" class="flex-1 px-3 py-1.5 border border-slate-200 rounded-lg text-sm font-mono">
          <button onclick="removeReplacement(${idx})" class="p-2 text-slate-400 hover:text-red-500">ğŸ—‘ï¸</button>
        </div>
      `).join('') + '<button onclick="addReplacement()" class="text-xs bg-slate-50 text-slate-700 px-2 py-1 rounded-md hover:bg-slate-100 mt-2">+ æ·»åŠ æ›¿æ¢è§„åˆ™</button>';
    }

    function renderBotRelaySection(acc) {
      const relays = acc.botRelays || [];
      return `
        <div class="mb-4 rounded-lg border border-slate-200 bg-slate-50/60 p-3 space-y-3">
          <div class="flex items-center justify-between">
            <div class="text-sm text-slate-700">é…ç½®å¤šä¸ªä¸­è½¬æœºå™¨äººï¼Œç¨ååœ¨æ¯æ¡è½¬å‘è§„åˆ™ä¸­é€‰æ‹©è¦ä½¿ç”¨çš„æœºå™¨äººã€‚</div>
            <div class="flex items-center gap-2">
              <button onclick="requestRelayLoginAll()" class="text-xs bg-emerald-50 text-emerald-600 px-2 py-1 rounded-md hover:bg-emerald-100">ä¸€é”®ç™»å½•</button>
              <button onclick="requestRelayStopAll()" class="text-xs bg-slate-100 text-slate-600 px-2 py-1 rounded-md hover:bg-slate-200">ä¸€é”®åœæ­¢</button>
              <button onclick="addBotRelay()" class="text-xs bg-indigo-50 text-indigo-600 px-2 py-1 rounded-md hover:bg-indigo-100">+ æ·»åŠ ä¸­è½¬æœºå™¨äºº</button>
            </div>
          </div>
          ${relays.length === 0 ? `<div class="text-sm text-slate-400">æš‚æ— ä¸­è½¬æœºå™¨äººï¼Œè¯·ç‚¹å‡»â€œæ·»åŠ â€åˆ›å»ºã€‚</div>` : relays.map((r, idx) => `
            <div class="grid gap-3 md:grid-cols-[1fr,1fr,auto] items-center bg-white/80 border border-slate-200 rounded-lg p-3">
              <div>
                <label class="block text-xs font-medium text-slate-600 mb-1">åç§°</label>
                <input type="text" value="${r.name || ''}" onchange="updateBotRelay(${idx}, 'name', this.value)"
                  class="w-full rounded-lg border border-slate-200 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none" placeholder="ä¾‹å¦‚ï¼šRelay-1">
              </div>
              <div>
                <label class="block text-xs font-medium text-slate-600 mb-1">æœºå™¨äºº Token</label>
                <input type="password" value="${r.token || ''}" onchange="updateBotRelay(${idx}, 'token', this.value)"
                  class="w-full rounded-lg border border-slate-200 px-3 py-2 text-sm font-mono focus:border-indigo-500 focus:outline-none" placeholder="æœºå™¨äºº Token">
              </div>
              <div class="flex flex-col items-end justify-center gap-2 pt-5 md:pt-0">
                <div class="text-xs">
                  <span class="px-2 py-0.5 rounded-full ${r.loginState === 'online' ? 'bg-emerald-50 text-emerald-700' : r.loginState === 'error' ? 'bg-red-50 text-red-700' : r.loginState === 'pending' ? 'bg-amber-50 text-amber-700' : 'bg-slate-100 text-slate-600'}">${r.loginState || 'idle'}</span>
                  ${r.loginMessage ? `<span class="ml-1 text-slate-500">${r.loginMessage}</span>` : ''}
                </div>
                <div class="flex items-center gap-2">
                  <button onclick="requestRelayLogin('${r.id}')" ${r.loginState === 'pending' || r.loginState === 'online' ? 'disabled' : ''} class="px-3 py-1.5 text-xs font-medium rounded-md border border-slate-200 ${r.loginState === 'pending' || r.loginState === 'online' ? 'cursor-not-allowed bg-slate-50' : 'hover:bg-slate-100'} text-slate-600">ç™»å½•</button>
                  <button onclick="requestRelayStop('${r.id}')" class="px-3 py-1.5 text-xs font-medium rounded-md border border-slate-200 hover:bg-slate-100 text-slate-600">åœæ­¢</button>
                  <button onclick="removeBotRelay(${idx})" class="px-3 py-1.5 text-xs font-medium rounded-md border border-slate-200 hover:bg-slate-100 text-slate-600">åˆ é™¤</button>
                </div>
              </div>
            </div>
          `).join('')}
        </div>
      `;
    }

    // å·¥å…·å‡½æ•°
    function getActiveAccount() {
      return state.accounts.find(a => a.id === state.activeId) || state.accounts[0];
    }

    function updateField(field, value) {
      const acc = getActiveAccount();
      acc[field] = value;
      // å½“å¯ç”¨è‡ªåŠ¨ç¿»è¯‘æ—¶ï¼Œè‡ªåŠ¨å°†æ‰€æœ‰é¢‘é“çš„ç¿»è¯‘æ–¹å‘è®¾ä¸º"è‡ªåŠ¨æ£€æµ‹"
      if (field === 'enableTranslation' && value === true) {
        if (!acc.channelTranslateDirection) acc.channelTranslateDirection = {};
        if (acc.mappings) {
          acc.mappings.forEach(m => {
            if (m.sourceChannelId) {
              acc.channelTranslateDirection[m.sourceChannelId] = 'auto';
            }
          });
        }
      }
      saveConfig();
      render();
    }

    function switchAccount(id) {
      state.activeId = id;
      render();
    }

    function addAccount() {
      const newAcc = {
        id: genId(),
        name: `è½¬å‘å®ä¾‹${state.accounts.length + 1}`,
        type: 'selfbot',
        token: '',
        proxyUrl: '',
        loginRequested: false,
        loginState: 'idle',
        showSourceIdentity: false,
        mappings: [],
        blockedKeywords: [],
        excludeKeywords: [],
        replacements: [],
        allowedUsersIds: [],
        mutedUsersIds: [],
        enableTranslation: false,
        translationProvider: 'deepseek',
        translationApiKey: '',
        translationSecret: '',
        deepseekApiKey: '',
        enableBotRelay: false,
        enableDiscordForward: true,
        botRelays: [],
        channelRelayMap: {},
        channelFeishuWebhooks: {},
        enableFeishuForward: false,
        feishuAppId: '',
        feishuAppSecret: '',
        ignoreSelf: false,
        ignoreBot: false,
        ignoreImages: false,
        ignoreAudio: false,
        ignoreVideo: false,
        ignoreDocuments: false
      };
      state.accounts.push(newAcc);
      state.activeId = newAcc.id;
      saveConfig();
      render();
    }

    function removeAccount() {
      if (state.accounts.length <= 1) return;
      if (!confirm('ç¡®å®šè¦åˆ é™¤å½“å‰è½¬å‘å®ä¾‹å—ï¼Ÿ')) return;
      state.accounts = state.accounts.filter(a => a.id !== state.activeId);
      state.activeId = state.accounts[0]?.id || '';
      saveConfig();
      render();
    }

    function addMapping() {
      const acc = getActiveAccount();
      if (!acc.mappings) acc.mappings = [];
      acc.mappings.push({ id: genId(), sourceChannelId: '', targetWebhookUrl: '', note: '' });
      saveConfig();
      render();
    }

    function updateMapping(idx, field, value) {
      const acc = getActiveAccount();
      if (acc.mappings[idx]) {
        const prevSource = acc.mappings[idx].sourceChannelId;
        acc.mappings[idx][field] = value;
        if (field === 'sourceChannelId') {
          if (!acc.channelRelayMap) acc.channelRelayMap = {};
          if (prevSource && acc.channelRelayMap[prevSource]) {
            const relayId = acc.channelRelayMap[prevSource];
            delete acc.channelRelayMap[prevSource];
            if (value) {
              acc.channelRelayMap[String(value)] = relayId;
            }
          }
          if (!acc.channelFeishuWebhooks) acc.channelFeishuWebhooks = {};
          if (prevSource && acc.channelFeishuWebhooks[prevSource]) {
            const feishu = acc.channelFeishuWebhooks[prevSource];
            delete acc.channelFeishuWebhooks[prevSource];
            if (value) {
              acc.channelFeishuWebhooks[String(value)] = feishu;
            }
          }
          if (!acc.channelTranslate) acc.channelTranslate = {};
          if (prevSource && Object.prototype.hasOwnProperty.call(acc.channelTranslate, prevSource)) {
            const tr = acc.channelTranslate[prevSource];
            delete acc.channelTranslate[prevSource];
            if (value) {
              acc.channelTranslate[String(value)] = tr;
            }
          }
          if (!acc.channelTranslateDirection) acc.channelTranslateDirection = {};
          if (prevSource && Object.prototype.hasOwnProperty.call(acc.channelTranslateDirection, prevSource)) {
            const dir = acc.channelTranslateDirection[prevSource];
            delete acc.channelTranslateDirection[prevSource];
            if (value) {
              acc.channelTranslateDirection[String(value)] = dir;
            }
          }
        }
        if (field === 'translateDirection') {
          if (!acc.channelTranslateDirection) acc.channelTranslateDirection = {};
          const sourceId = acc.mappings[idx].sourceChannelId;
          if (value === 'off') {
            // å…³é—­ç¿»è¯‘æ—¶ï¼Œåˆ é™¤è¯¥é¢‘é“çš„ç¿»è¯‘é…ç½®
            if (acc.channelTranslateDirection[sourceId]) {
              delete acc.channelTranslateDirection[sourceId];
            }
            if (acc.channelTranslate && acc.channelTranslate[sourceId]) {
              delete acc.channelTranslate[sourceId];
            }
          } else {
            // å¼€å¯ç¿»è¯‘æ—¶ï¼Œè®¾ç½®ç¿»è¯‘æ–¹å‘
            acc.channelTranslateDirection[sourceId] = value;
            if (!acc.channelTranslate) acc.channelTranslate = {};
            acc.channelTranslate[sourceId] = true;
          }
        }
        saveConfig();
      }
    }

    function removeMapping(idx) {
      const acc = getActiveAccount();
      const sourceId = acc.mappings[idx]?.sourceChannelId;
      acc.mappings.splice(idx, 1);
      if (sourceId && acc.channelRelayMap && acc.channelRelayMap[sourceId]) {
        delete acc.channelRelayMap[sourceId];
      }
      saveConfig();
      render();
    }

    function updateMappingRelay(idx, relayId) {
      const acc = getActiveAccount();
      const mapping = acc.mappings?.[idx];
      if (!mapping || !mapping.sourceChannelId) return;
      if (!acc.channelRelayMap) acc.channelRelayMap = {};
      if (relayId) {
        acc.channelRelayMap[mapping.sourceChannelId] = relayId;
      } else {
        delete acc.channelRelayMap[mapping.sourceChannelId];
      }
      saveConfig();
    }

    function addFeishuMapping() {
      const acc = getActiveAccount();
      if (!acc.channelFeishuWebhooks) acc.channelFeishuWebhooks = {};
      acc.channelFeishuWebhooks[''] = '';
      saveConfig();
      render();
    }

    function updateFeishuSource(idx, value) {
      const acc = getActiveAccount();
      if (!acc.channelFeishuWebhooks) acc.channelFeishuWebhooks = {};
      const entries = Object.entries(acc.channelFeishuWebhooks);
      const hit = entries[idx];
      if (!hit) return;
      const [oldSource, webhook] = hit;
      const notes = acc.channelNotes || {};
      delete acc.channelFeishuWebhooks[oldSource];
      acc.channelFeishuWebhooks[value || ''] = webhook;
      if (notes && Object.prototype.hasOwnProperty.call(notes, oldSource)) {
        notes[value || ''] = notes[oldSource];
        if (oldSource !== (value || '')) delete notes[oldSource];
        acc.channelNotes = notes;
      }
      saveConfig();
      render();
    }

    function updateFeishuWebhookEntry(idx, value) {
      const acc = getActiveAccount();
      if (!acc.channelFeishuWebhooks) acc.channelFeishuWebhooks = {};
      const entries = Object.entries(acc.channelFeishuWebhooks);
      const hit = entries[idx];
      if (!hit) return;
      const [source] = hit;
      if (value && value.trim()) {
        acc.channelFeishuWebhooks[source] = value.trim();
      } else {
        delete acc.channelFeishuWebhooks[source];
      }
      saveConfig();
      render();
    }

    function updateFeishuNote(idx, value) {
      const acc = getActiveAccount();
      const entries = Object.entries(acc.channelFeishuWebhooks || {});
      const hit = entries[idx];
      if (!hit) return;
      const [source] = hit;
      if (!acc.channelNotes) acc.channelNotes = {};
      if (value && value.trim()) {
        acc.channelNotes[source] = value.trim();
      } else {
        delete acc.channelNotes[source];
      }
      saveConfig();
    }

    function removeFeishuMapping(idx) {
      const acc = getActiveAccount();
      const entries = Object.entries(acc.channelFeishuWebhooks || {});
      const hit = entries[idx];
      if (!hit) return;
      const [source] = hit;
      delete acc.channelFeishuWebhooks[source];
      if (acc.channelNotes && acc.channelNotes[source] !== undefined) {
        delete acc.channelNotes[source];
      }
      saveConfig();
      render();
    }

    function addKeyword(field, value) {
      if (!value.trim()) return;
      const acc = getActiveAccount();
      if (!acc[field]) acc[field] = [];
      if (!acc[field].includes(value.trim())) {
        acc[field].push(value.trim());
        saveConfig();
        render();
      }
    }

    function removeKeyword(field, keyword) {
      const acc = getActiveAccount();
      acc[field] = acc[field].filter(k => k !== keyword);
      saveConfig();
      render();
    }

    function addReplacement() {
      const acc = getActiveAccount();
      if (!acc.replacements) acc.replacements = [];
      acc.replacements.push({ from: '', to: '' });
      saveConfig();
      render();
    }

    function updateReplacement(idx, field, value) {
      const acc = getActiveAccount();
      if (acc.replacements[idx]) {
        acc.replacements[idx][field] = value;
        saveConfig();
      }
    }

    function removeReplacement(idx) {
      const acc = getActiveAccount();
      acc.replacements.splice(idx, 1);
      saveConfig();
      render();
    }

    function addBotRelay() {
      const acc = getActiveAccount();
      if (!acc.botRelays) acc.botRelays = [];
      acc.botRelays.push({ id: genId(), name: `ä¸­è½¬æœºå™¨äºº${acc.botRelays.length + 1}`, token: '', loginState: 'idle', loginMessage: '' });
      saveConfig();
      render();
    }

    function updateBotRelay(idx, field, value) {
      const acc = getActiveAccount();
      if (!acc.botRelays || !acc.botRelays[idx]) return;
      acc.botRelays[idx][field] = value;
      saveConfig();
    }

    function removeBotRelay(idx) {
      const acc = getActiveAccount();
      if (!acc.botRelays) return;
      const removed = acc.botRelays[idx];
      acc.botRelays.splice(idx, 1);
      // æ¸…ç†æ˜ å°„ä¸­ä½¿ç”¨è¯¥æœºå™¨äººçš„ç»‘å®š
      if (removed?.id && acc.channelRelayMap) {
        Object.keys(acc.channelRelayMap).forEach((k) => {
          if (acc.channelRelayMap[k] === removed.id) {
            delete acc.channelRelayMap[k];
          }
        });
      }
      saveConfig();
      render();
    }

    async function requestRelayLogin(relayId) {
      const acc = getActiveAccount();
      if (!relayId) return;
      const current = (acc.botRelays || []).find(r => r.id === relayId);
      if (current && (current.loginState === 'pending' || current.loginState === 'online')) return;
      // æœ¬åœ°å…ˆç½®ä¸º pending
      acc.botRelays = (acc.botRelays || []).map((r) =>
        r.id === relayId ? { ...r, loginState: 'pending', loginMessage: 'æ­£åœ¨ç™»å½• Token...' } : r
      );
      render();
      try {
        const res = await fetch('/api/account/action', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ accountId: acc.id, action: 'relayLogin', relayIds: [relayId] })
        });
        const data = await res.json();
        if (data?.results) {
          acc.botRelays = (acc.botRelays || []).map((r) => {
            const hit = data.results[r.id];
            return hit ? { ...r, loginState: hit.loginState, loginMessage: hit.loginMessage } : r;
          });
          saveConfig();
        } else if (!res.ok) {
          acc.botRelays = (acc.botRelays || []).map((r) =>
            r.id === relayId ? { ...r, loginState: 'error', loginMessage: data?.error || `ç™»å½•å¤±è´¥(${res.status})` } : r
          );
          saveConfig();
        }
        render();
      } catch (e) {
        console.error('relay login failed', e);
        acc.botRelays = (acc.botRelays || []).map((r) =>
          r.id === relayId ? { ...r, loginState: 'error', loginMessage: 'è¯·æ±‚å¤±è´¥' } : r
        );
        saveConfig();
        render();
      }
    }

    async function requestRelayLoginAll() {
      const acc = getActiveAccount();
      // å¦‚æœå…¨éƒ¨éƒ½åœ¨ pending/online åˆ™è·³è¿‡
      const canLogin = (acc.botRelays || []).some(r => r.loginState !== 'pending' && r.loginState !== 'online');
      if (!canLogin) return;
      // æœ¬åœ°å…ˆç½®ä¸º pending
      acc.botRelays = (acc.botRelays || []).map((r) => ({ ...r, loginState: 'pending', loginMessage: 'æ­£åœ¨ç™»å½• Token...' }));
      render();
      try {
        const res = await fetch('/api/account/action', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ accountId: acc.id, action: 'relayLogin' })
        });
        const data = await res.json();
        if (data?.results) {
          acc.botRelays = (acc.botRelays || []).map((r) => {
            const hit = data.results[r.id];
            return hit ? { ...r, loginState: hit.loginState, loginMessage: hit.loginMessage } : r;
          });
          saveConfig();
        } else if (!res.ok) {
          acc.botRelays = (acc.botRelays || []).map((r) => ({
            ...r,
            loginState: 'error',
            loginMessage: data?.error || `ç™»å½•å¤±è´¥(${res.status})`,
          }));
          saveConfig();
        }
        render();
      } catch (e) {
        console.error('relay login all failed', e);
        acc.botRelays = (acc.botRelays || []).map((r) => ({ ...r, loginState: 'error', loginMessage: 'è¯·æ±‚å¤±è´¥' }));
        saveConfig();
        render();
      }
    }

    function requestRelayStop(relayId) {
      const acc = getActiveAccount();
      if (!relayId) return;
      acc.botRelays = (acc.botRelays || []).map((r) =>
        r.id === relayId ? { ...r, loginState: 'idle', loginMessage: 'å·²åœæ­¢' } : r
      );
      saveConfig();
      render();
    }

    function requestRelayStopAll() {
      const acc = getActiveAccount();
      acc.botRelays = (acc.botRelays || []).map((r) => ({ ...r, loginState: 'idle', loginMessage: 'å·²åœæ­¢' }));
      saveConfig();
      render();
    }

    async function requestLogin() {
      const acc = getActiveAccount();
      if (acc.loginState === 'online' || acc.loginState === 'pending') return;
      
      acc.loginState = 'pending';
      acc.loginMessage = 'æ­£åœ¨ç™»å½•...';
      render();

      try {
        const res = await fetch('/api/account/action', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ accountId: acc.id, action: 'login' })
        });
        const data = await res.json();
        if (!res.ok && data.loginState === 'online') {
          acc.loginState = 'online';
          acc.loginMessage = 'å·²ç™»å½•';
        }
      } catch (e) {
        acc.loginState = 'idle';
        acc.loginMessage = 'ç™»å½•è¯·æ±‚å¤±è´¥';
      }
      render();
    }

    async function requestStop() {
      const acc = getActiveAccount();
      if (acc.loginState === 'pending' || (acc.loginState !== 'online' && acc.loginState !== 'error')) return;
      
      acc.loginState = 'idle';
      acc.loginMessage = 'æ­£åœ¨åœæ­¢...';
      render();

      try {
        const res = await fetch('/api/account/action', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ accountId: acc.id, action: 'stop' })
        });
        const data = await res.json();
        if (res.ok) {
          acc.loginState = data.loginState || 'idle';
          acc.loginMessage = data.loginMessage || 'å·²åœæ­¢';
        }
      } catch (e) {
        acc.loginState = acc.loginState || 'idle';
        acc.loginMessage = 'åœæ­¢è¯·æ±‚å¤±è´¥';
      }
      render();
    }

    function showHelp() {
      document.getElementById('helpPanel').classList.remove('hidden');
    }

    function hideHelp() {
      document.getElementById('helpPanel').classList.add('hidden');
    }

    async function exportConfig() {
      try {
        const res = await fetch('/api/config');
        const data = await res.json();
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `discord-forwarder-config-${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.json`;
        a.click();
        URL.revokeObjectURL(url);
      } catch (e) {
        alert('å¯¼å‡ºå¤±è´¥: ' + e.message);
      }
    }

    // çŠ¶æ€è½®è¯¢
    function startStatusPolling() {
      setInterval(async () => {
        try {
          const res = await fetch('/api/config');
          const data = await res.json();
          if (Array.isArray(data?.accounts)) {
            const hasChange = data.accounts.some((ra, idx) => {
              const la = state.accounts[idx];
              if (!la) return false;
              return (
                ra.loginState !== la.loginState || 
                ra.loginMessage !== la.loginMessage
              );
            });
            if (hasChange) {
              state.accounts.forEach((acc, idx) => {
                const remote = data.accounts[idx];
                if (remote && acc.id === remote.id) {
                  if (acc.loginState !== 'pending' || remote.loginState !== 'idle') {
                    acc.loginState = remote.loginState || acc.loginState;
                    acc.loginMessage = remote.loginMessage || acc.loginMessage;
                  }
                }
              });
              render();
            }
          }
        } catch (e) {
          // å¿½ç•¥è½®è¯¢é”™è¯¯
        }
      }, 2000);
    }

    // å¯åŠ¨
    init();
  </script>
</body>
</html>

