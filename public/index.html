<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Discord Forwarder Config</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 p-4 md:p-8 font-sans">
  <div class="max-w-7xl mx-auto space-y-8">
    <header class="flex flex-col md:flex-row md:items-center justify-between gap-4 pb-6 border-b border-slate-200">
      <div>
        <h1 class="text-2xl md:text-3xl font-bold text-slate-900 tracking-tight">Discord Forwarder Config</h1>
        <p class="text-slate-500 mt-1 text-sm md:text-base">å¯è§†åŒ–é…ç½®ç”Ÿæˆå™¨ Â· è½»æ¾ç®¡ç†è½¬å‘è§„åˆ™</p>
      </div>
      <div class="flex items-center gap-2 text-sm text-slate-500 bg-white px-3 py-1.5 rounded-full border border-slate-200 shadow-sm">
        <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
        æœ¬åœ°è‡ªåŠ¨ä¿å­˜ä¸­
      </div>
    </header>

    <div id="app" style="display: none;">
      <!-- è´¦å·åˆ‡æ¢æ ‡ç­¾ -->
      <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden mb-6">
        <div class="flex flex-col gap-3 border-b border-slate-100 bg-slate-50/60 p-4">
          <div class="flex flex-wrap items-center gap-2" id="accountTabs"></div>
          <div class="flex flex-wrap items-center gap-2">
            <button onclick="showHelp()" class="inline-flex items-center gap-1 rounded-md border border-slate-200 px-3 py-1.5 text-xs font-medium text-slate-600 hover:bg-slate-100">
              <span>â„¹ï¸</span> ä½¿ç”¨è¯´æ˜
            </button>
            <button onclick="exportConfig()" class="inline-flex items-center gap-1 rounded-md border border-indigo-200 px-3 py-1.5 text-xs font-medium text-indigo-600 hover:bg-indigo-50">
              <span>â¬‡ï¸</span> å¯¼å‡ºé…ç½®
            </button>
            <button onclick="removeAccount()" class="inline-flex items-center gap-1 rounded-md border border-red-200 px-3 py-1.5 text-xs font-medium text-red-600 hover:bg-red-50">
              <span>ğŸ—‘ï¸</span> åˆ é™¤å½“å‰å®ä¾‹
            </button>
          </div>
        </div>
        <div id="helpPanel" class="hidden border-b border-slate-100 bg-slate-50 px-6 py-4 text-sm leading-relaxed text-slate-600">
          <button onclick="hideHelp()" class="float-right text-slate-400 hover:text-slate-600">âœ•</button>
          <p class="font-semibold text-slate-800">ä½¿ç”¨è¯´æ˜</p>
          <ul class="mt-2 list-disc space-y-1 pl-5">
            <li>ä¸€ä¸ªè½¬å‘å®ä¾‹å¯¹åº”ä¸€ä¸ª Discord Tokenï¼Œå¯é€‰æ‹©æœºå™¨äºº Token æˆ–è‡ªç”¨å· Tokenã€‚</li>
            <li>æ¯ä¸ªè½¬å‘å®ä¾‹éƒ½å¯ä»¥å•ç‹¬é…ç½®è½¬å‘è§„åˆ™ã€å…³é”®è¯ã€æ’é™¤/æ›¿æ¢è§„åˆ™ã€‚</li>
            <li>è½¬å‘æ—¶å¦‚éœ€ä¼ªè£…ä¸ºæºç”¨æˆ·ï¼Œè¯·å‹¾é€‰ã€Œä½¿ç”¨æºç”¨æˆ·æ˜µç§°å’Œå¤´åƒã€ã€‚</li>
            <li>æ’é™¤å…³é”®è¯ä¼šç›´æ¥åˆ é™¤å‘½ä¸­çš„è¯ï¼Œè€Œä¸ä¼šé˜»æ­¢æ•´æ¡æ¶ˆæ¯è½¬å‘ã€‚</li>
            <li>å¯ä»¥æ·»åŠ å¤šä¸ªè½¬å‘å®ä¾‹å¹¶è¡Œè¿è¡Œï¼Œåç«¯ä¼šä¸ºæ¯ä¸ªå®ä¾‹ç‹¬ç«‹ç™»å½•å¹¶è½¬å‘ã€‚</li>
            <li class="mt-3 font-semibold text-slate-700">å…³äº Tokenï¼š</li>
            <li class="pl-4">â€¢ æ­¤ Token ä¸ Discord Bot Token ä¸åŒã€‚</li>
            <li class="pl-4">â€¢ æ­¤ Token åœ¨æ‚¨æ›´æ”¹å¯†ç æ—¶ä¼šå‘ç”Ÿå˜åŒ–ã€‚</li>
            <li class="pl-4">â€¢ å¦‚æœå¯ç”¨äº†åŒå› ç´ è®¤è¯ï¼ˆ2FAï¼‰ï¼Œéœ€è¦å…ˆç¦ç”¨å®ƒæ‰èƒ½è·å– Tokenã€‚</li>
          </ul>
        </div>
      </div>

      <!-- é…ç½®è¡¨å• -->
      <div id="configForm"></div>
    </div>

    <footer class="text-center text-slate-400 text-xs py-8">
      <p>Discord Forwarder Management</p>
    </footer>
  </div>

  <script>
    // å…¼å®¹çš„ ID ç”Ÿæˆå‡½æ•°
    function genId() {
      try {
        if (typeof crypto !== 'undefined' && crypto.randomUUID) {
          return crypto.randomUUID();
        }
        if (typeof globalThis !== 'undefined' && globalThis.crypto && globalThis.crypto.randomUUID) {
          return globalThis.crypto.randomUUID();
        }
      } catch (e) {
        // é™çº§æ–¹æ¡ˆ
      }
      // é™çº§ï¼šä½¿ç”¨æ—¶é—´æˆ³ + éšæœºæ•°
      return `id_${Date.now().toString(36)}_${Math.random().toString(36).slice(2, 8)}`;
    }

    let state = { accounts: [], activeId: "" };
    let saveTimer = null;

    // åˆå§‹åŒ–
    async function init() {
      try {
        await loadConfig();
        // å¦‚æœæ²¡æœ‰è´¦å·ï¼Œåˆ›å»ºä¸€ä¸ªé»˜è®¤è´¦å·
        if (state.accounts.length === 0) {
          addAccount();
        }
      } catch (e) {
        console.error('åˆå§‹åŒ–å¤±è´¥', e);
        // å³ä½¿åŠ è½½å¤±è´¥ï¼Œä¹Ÿæ˜¾ç¤ºç•Œé¢
        if (state.accounts.length === 0) {
          addAccount();
        }
      } finally {
        document.getElementById('app').style.display = 'block';
        render();
        startStatusPolling();
      }
    }

    // åŠ è½½é…ç½®
    async function loadConfig() {
      try {
        const res = await fetch('/api/config');
        if (!res.ok) {
          console.error('åŠ è½½é…ç½®å¤±è´¥: HTTP', res.status);
          return;
        }
        const data = await res.json();
        console.log('åŠ è½½é…ç½®æˆåŠŸ:', data);
        if (Array.isArray(data?.accounts)) {
          state = { accounts: data.accounts, activeId: data.activeId || data.accounts[0]?.id || "" };
        } else {
          console.warn('é…ç½®æ•°æ®æ ¼å¼ä¸æ­£ç¡®:', data);
        }
      } catch (e) {
        console.error('åŠ è½½é…ç½®å¤±è´¥', e);
        throw e; // é‡æ–°æŠ›å‡ºé”™è¯¯ï¼Œè®© init å¤„ç†
      }
    }

    // ä¿å­˜é…ç½®ï¼ˆé˜²æŠ–ï¼‰
    async function saveConfig() {
      if (saveTimer) clearTimeout(saveTimer);
      saveTimer = setTimeout(async () => {
        try {
          await fetch('/api/config', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(state)
          });
        } catch (e) {
          console.error('ä¿å­˜å¤±è´¥', e);
        }
      }, 800);
    }

    // æ¸²æŸ“ç•Œé¢
    function render() {
      // ç¡®ä¿ app å…ƒç´ å­˜åœ¨
      const appEl = document.getElementById('app');
      if (!appEl) {
        console.error('æ‰¾ä¸åˆ° app å…ƒç´ ');
        return;
      }

      if (state.accounts.length === 0) {
        // å¦‚æœæ²¡æœ‰è´¦å·ï¼Œæ˜¾ç¤ºæç¤ºå’Œæ·»åŠ æŒ‰é’®
        appEl.innerHTML = `
          <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-8 text-center">
            <p class="text-slate-400 mb-4">æš‚æ— è½¬å‘å®ä¾‹</p>
            <button onclick="addAccount(); render();" class="inline-flex items-center gap-1 rounded-md bg-indigo-600 px-4 py-2 text-sm font-medium text-white hover:bg-indigo-500">
              + æ·»åŠ è½¬å‘å®ä¾‹
            </button>
          </div>
        `;
        return;
      }

      const activeAccount = state.accounts.find(a => a.id === state.activeId) || state.accounts[0];
      
      // æ¸²æŸ“è´¦å·æ ‡ç­¾
      // æ¸²æŸ“è´¦å·æ ‡ç­¾
      const accountTabsEl = document.getElementById('accountTabs');
      const configFormEl = document.getElementById('configForm');
      
      if (!accountTabsEl || !configFormEl) {
        console.error('æ‰¾ä¸åˆ°å¿…è¦çš„ DOM å…ƒç´ ');
        return;
      }

      let tabsHtml = state.accounts.map(acc => `
        <button onclick="switchAccount('${acc.id}')" 
          class="rounded-full px-3 py-1 text-sm font-medium transition ${
            acc.id === state.activeId 
              ? 'bg-indigo-600 text-white shadow' 
              : 'bg-white text-slate-600 border border-slate-200 hover:bg-slate-100'
          }">
          ${acc.name || 'æœªå‘½åè´¦å·'}
        </button>
      `).join('');
      tabsHtml += `<button onclick="addAccount(); render();" class="inline-flex items-center gap-1 rounded-full border border-dashed border-indigo-300 px-3 py-1 text-sm font-medium text-indigo-600 hover:bg-indigo-50">+ æ·»åŠ è½¬å‘å®ä¾‹</button>`;
      accountTabsEl.innerHTML = tabsHtml;

      // æ¸²æŸ“é…ç½®è¡¨å•
      configFormEl.innerHTML = renderAccountForm(activeAccount);
    }

    // æ¸²æŸ“è´¦å·é…ç½®è¡¨å•
    function renderAccountForm(acc) {
      const isPending = acc.loginState === 'pending';
      const isOnline = acc.loginState === 'online';
      
      return `
        <!-- åŸºç¡€è®¾ç½® -->
        <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden mb-4">
          <div class="px-6 py-4 border-b border-slate-100 bg-slate-50/50">
            <h2 class="font-semibold text-slate-800">åŸºç¡€è®¾ç½®</h2>
          </div>
          <div class="p-6 space-y-4">
            <div class="grid gap-4 md:grid-cols-2">
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1">å®ä¾‹åç§°</label>
              <input type="text" value="${acc.name || ''}" onchange="updateField('name', this.value)" 
                class="w-full rounded-lg border border-slate-200 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none">
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1">è´¦å·ç±»å‹</label>
              <select onchange="updateField('type', this.value)" 
                class="w-full rounded-lg border border-slate-200 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none">
                <option value="selfbot" ${acc.type === 'selfbot' ? 'selected' : ''}>ğŸ’¬ ç”¨æˆ· Tokenï¼ˆSelfBotï¼‰</option>
                <option value="bot" ${acc.type === 'bot' ? 'selected' : ''}>ğŸ¤– æœºå™¨äºº Token</option>
              </select>
            </div>
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1">Discord Token</label>
              <div class="flex gap-2">
                <input type="password" value="${acc.token || ''}" onchange="updateField('token', this.value)" 
                  placeholder="OT..." class="flex-1 px-3 py-2 border border-slate-200 rounded-lg focus:outline-none font-mono text-sm">
                <button onclick="requestLogin()" ${isPending || isOnline ? 'disabled' : ''} 
                  class="px-3 py-1.5 text-xs font-medium rounded-md ${isPending || isOnline ? 'bg-indigo-300 cursor-not-allowed' : 'bg-indigo-600 hover:bg-indigo-500'} text-white">
                  ${isPending ? 'ç™»å½•ä¸­...' : isOnline ? 'å·²ç™»å½•' : 'ç™»å½•'}
                </button>
                <button onclick="requestStop()" ${isPending || (!isOnline && acc.loginState !== 'error') ? 'disabled' : ''}
                  class="px-3 py-1.5 text-xs font-medium rounded-md border border-slate-200 ${isPending || (!isOnline && acc.loginState !== 'error') ? 'cursor-not-allowed bg-slate-50' : 'hover:bg-slate-100'}">
                  åœæ­¢
                </button>
              </div>
              <div class="text-xs text-slate-500 mt-1">
                çŠ¶æ€: <span class="px-2 py-0.5 rounded-full ${acc.loginState === 'online' ? 'bg-emerald-50 text-emerald-700' : acc.loginState === 'error' ? 'bg-red-50 text-red-700' : 'bg-slate-100 text-slate-600'}">${acc.loginState || 'idle'}</span>
                ${acc.loginMessage ? `<span class="ml-2">${acc.loginMessage}</span>` : ''}
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1">ä»£ç†åœ°å€</label>
              <input type="text" value="${acc.proxyUrl || ''}" onchange="updateField('proxyUrl', this.value)" 
                placeholder="http://127.0.0.1:7890" class="w-full px-3 py-2 border border-slate-200 rounded-lg focus:outline-none font-mono text-sm">
            </div>
            <div class="flex items-center gap-2">
              <input type="checkbox" ${acc.showSourceIdentity ? 'checked' : ''} onchange="updateField('showSourceIdentity', this.checked)" 
                class="h-4 w-4 rounded border-slate-300">
              <label class="text-sm text-slate-700">ä½¿ç”¨æºç”¨æˆ·çš„æ˜µç§°å’Œå¤´åƒè¿›è¡Œè½¬å‘</label>
            </div>
            <div class="border-t pt-4">
              <div class="flex items-center gap-2 mb-2">
                <input type="checkbox" ${acc.enableBotRelay ? 'checked' : ''} ${acc.type === 'bot' ? 'disabled' : ''} onchange="updateField('enableBotRelay', this.checked)" 
                  class="h-4 w-4 rounded border-slate-300 ${acc.type === 'bot' ? 'opacity-50 cursor-not-allowed' : ''}">
                <label class="text-sm text-slate-700 ${acc.type === 'bot' ? 'text-slate-400' : ''}">æœºå™¨äººä¸­è½¬ï¼ˆé€šè¿‡æœºå™¨äººå‘é€åˆ°ç›®æ ‡ç¾¤ç»„ï¼‰${acc.type === 'bot' ? 'ï¼ˆæœºå™¨äººè´¦å·ç±»å‹ä¸æ”¯æŒï¼‰' : ''}</label>
              </div>
              ${acc.enableBotRelay && acc.type !== 'bot' ? `
                <div class="mb-4">
                  <label class="block text-sm font-medium text-slate-700 mb-1">æœºå™¨äºº Token</label>
                  <div class="flex gap-2">
                    <input type="password" value="${acc.botRelayToken || ''}" onchange="updateField('botRelayToken', this.value)" 
                      placeholder="æœºå™¨äºº Tokenï¼ˆç”¨äºä¸­è½¬å‘é€ï¼‰" class="flex-1 px-3 py-2 border border-slate-200 rounded-lg focus:outline-none font-mono text-sm">
                    <button onclick="requestBotRelayLogin()" ${(acc.botRelayLoginState === 'pending' || acc.botRelayLoginState === 'online') ? 'disabled' : ''} 
                      class="px-3 py-1.5 text-xs font-medium rounded-md ${(acc.botRelayLoginState === 'pending' || acc.botRelayLoginState === 'online') ? 'bg-indigo-300 cursor-not-allowed' : 'bg-indigo-600 hover:bg-indigo-500'} text-white">
                      ${acc.botRelayLoginState === 'pending' ? 'ç™»å½•ä¸­...' : acc.botRelayLoginState === 'online' ? 'å·²ç™»å½•' : 'ç™»å½•'}
                    </button>
                    <button onclick="requestBotRelayStop()" ${acc.botRelayLoginState === 'pending' || (acc.botRelayLoginState !== 'online' && acc.botRelayLoginState !== 'error') ? 'disabled' : ''}
                      class="px-3 py-1.5 text-xs font-medium rounded-md border border-slate-200 ${acc.botRelayLoginState === 'pending' || (acc.botRelayLoginState !== 'online' && acc.botRelayLoginState !== 'error') ? 'cursor-not-allowed bg-slate-50' : 'hover:bg-slate-100'}">
                      åœæ­¢
                    </button>
                  </div>
                  <div class="text-xs text-slate-500 mt-1">
                    çŠ¶æ€: <span class="px-2 py-0.5 rounded-full ${acc.botRelayLoginState === 'online' ? 'bg-emerald-50 text-emerald-700' : acc.botRelayLoginState === 'error' ? 'bg-red-50 text-red-700' : 'bg-slate-100 text-slate-600'}">${acc.botRelayLoginState || 'idle'}</span>
                    ${acc.botRelayLoginMessage ? `<span class="ml-2">${acc.botRelayLoginMessage}</span>` : ''}
                  </div>
                </div>
              ` : ''}
              <div class="flex items-center gap-2 mb-2">
                <input type="checkbox" ${acc.enableTranslation ? 'checked' : ''} onchange="updateField('enableTranslation', this.checked)" 
                  class="h-4 w-4 rounded border-slate-300">
                <label class="text-sm text-slate-700">å¯ç”¨è‡ªåŠ¨ç¿»è¯‘</label>
              </div>
              ${acc.enableTranslation ? `
                <div class="mb-2">
                  <label class="block text-sm font-medium text-slate-700 mb-1">ç¿»è¯‘æœåŠ¡</label>
                  <select onchange="updateField('translationProvider', this.value)" 
                    class="w-full rounded-lg border border-slate-200 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none">
                    <option value="deepseek" ${acc.translationProvider === 'deepseek' || !acc.translationProvider ? 'selected' : ''}>DeepSeek AI</option>
                    <option value="google" ${acc.translationProvider === 'google' ? 'selected' : ''}>Google ç¿»è¯‘</option>
                    <option value="baidu" ${acc.translationProvider === 'baidu' ? 'selected' : ''}>ç™¾åº¦ç¿»è¯‘</option>
                    <option value="youdao" ${acc.translationProvider === 'youdao' ? 'selected' : ''}>æœ‰é“æ™ºäº‘ç¿»è¯‘</option>
                    <option value="openai" ${acc.translationProvider === 'openai' ? 'selected' : ''}>OpenAI</option>
                  </select>
                </div>
                <div>
                  <label class="block text-sm font-medium text-slate-700 mb-1">API Key / App ID</label>
                  <input type="password" value="${acc.translationApiKey || acc.deepseekApiKey || ''}" onchange="updateField('translationApiKey', this.value)" 
                    placeholder="æ ¹æ®é€‰æ‹©çš„ç¿»è¯‘æœåŠ¡å¡«å†™å¯¹åº”çš„ API Key" class="w-full px-3 py-2 border border-slate-200 rounded-lg focus:outline-none font-mono text-sm">
                </div>
                ${acc.translationProvider === 'baidu' || acc.translationProvider === 'youdao' ? `
                  <div class="mt-2">
                    <label class="block text-sm font-medium text-slate-700 mb-1">App Secret / Secret Key</label>
                    <input type="password" value="${acc.translationSecret || ''}" onchange="updateField('translationSecret', this.value)" 
                      placeholder="ç™¾åº¦/æœ‰é“æ™ºäº‘ç¿»è¯‘éœ€è¦å¡«å†™ Secret Key" class="w-full px-3 py-2 border border-slate-200 rounded-lg focus:outline-none font-mono text-sm">
                  </div>
                ` : ''}
              ` : ''}
            </div>
          </div>
        </div>

        <!-- å¿½ç•¥é€‰é¡¹ -->
        <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden mb-4">
          <div class="px-6 py-4 border-b border-slate-100 bg-slate-50/50">
            <h2 class="font-semibold text-slate-800">å¿½ç•¥é€‰é¡¹</h2>
            <p class="text-xs text-slate-500 mt-1">é€‰æ‹©æ‚¨æƒ³è¦å¿½ç•¥çš„é¡¹ç›®</p>
          </div>
          <div class="p-6">
            <div class="flex flex-wrap items-center gap-4">
              <label class="inline-flex items-center gap-2 text-sm text-slate-700">
              <input type="checkbox" ${acc.ignoreSelf ? 'checked' : ''} onchange="updateField('ignoreSelf', this.checked)" 
                class="h-4 w-4 rounded border-slate-300"> å¿½ç•¥è‡ªå·±çš„æ¶ˆæ¯
              </label>
              <label class="inline-flex items-center gap-2 text-sm text-slate-700">
              <input type="checkbox" ${acc.ignoreBot ? 'checked' : ''} onchange="updateField('ignoreBot', this.checked)" 
                class="h-4 w-4 rounded border-slate-300"> å¿½ç•¥æœºå™¨äººæ¶ˆæ¯
              </label>
              <label class="inline-flex items-center gap-2 text-sm text-slate-700">
              <input type="checkbox" ${acc.ignoreImages ? 'checked' : ''} onchange="updateField('ignoreImages', this.checked)" 
                class="h-4 w-4 rounded border-slate-300"> å¿½ç•¥å›¾ç‰‡
              </label>
              <label class="inline-flex items-center gap-2 text-sm text-slate-700">
              <input type="checkbox" ${acc.ignoreAudio ? 'checked' : ''} onchange="updateField('ignoreAudio', this.checked)" 
                class="h-4 w-4 rounded border-slate-300"> å¿½ç•¥éŸ³é¢‘
              </label>
              <label class="inline-flex items-center gap-2 text-sm text-slate-700">
              <input type="checkbox" ${acc.ignoreVideo ? 'checked' : ''} onchange="updateField('ignoreVideo', this.checked)" 
                class="h-4 w-4 rounded border-slate-300"> å¿½ç•¥è§†é¢‘
              </label>
              <label class="inline-flex items-center gap-2 text-sm text-slate-700">
              <input type="checkbox" ${acc.ignoreDocuments ? 'checked' : ''} onchange="updateField('ignoreDocuments', this.checked)" 
                class="h-4 w-4 rounded border-slate-300"> å¿½ç•¥æ–‡æ¡£
              </label>
            </div>
          </div>
        </div>

        <!-- è½¬å‘è§„åˆ™ -->
        <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden mb-4">
          <div class="px-6 py-4 border-b border-slate-100 bg-slate-50/50">
            <h2 class="font-semibold text-slate-800">è½¬å‘è§„åˆ™</h2>
          </div>
          <div class="p-6 space-y-4" id="mappingsList">
            ${renderMappings(acc.mappings || [])}
          </div>
          <div class="px-6 pb-4 flex justify-end">
            <button onclick="addMapping()" class="text-xs bg-indigo-50 text-indigo-600 px-3 py-1.5 rounded-md hover:bg-indigo-100">+ æ·»åŠ è§„åˆ™</button>
          </div>
        </div>

        <!-- å…³é”®è¯è¿‡æ»¤ -->
        <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden mb-4">
          <div class="px-6 py-4 border-b border-slate-100 bg-slate-50/50">
            <h2 class="font-semibold text-slate-800">å…³é”®è¯è§¦å‘ï¼ˆè‡³å°‘å‘½ä¸­ä¸€ä¸ªæ‰è½¬å‘ï¼‰</h2>
          </div>
          <div class="p-6">
            <div class="flex flex-wrap gap-2 mb-3">
              ${(acc.blockedKeywords || []).map(k => `
                <span class="inline-flex items-center gap-1 px-2.5 py-1 rounded-full bg-red-50 text-red-600 text-sm border border-red-100">
                  ${k} <button onclick="removeKeyword('blockedKeywords', '${k}')" class="hover:text-red-800">âœ•</button>
                </span>
              `).join('')}
              <input type="text" placeholder="è¾“å…¥å…³é”®è¯åå›è½¦..." onkeydown="if(event.key==='Enter') addKeyword('blockedKeywords', this.value); this.value='';" 
                class="flex-1 min-w-[120px] px-3 py-1 border-none focus:outline-none text-sm">
            </div>
          </div>
        </div>

        <!-- æ’é™¤å…³é”®è¯ -->
        <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden mb-4">
          <div class="px-6 py-4 border-b border-slate-100 bg-slate-50/50">
            <h2 class="font-semibold text-slate-800">å±è”½å…³é”®è¯ï¼ˆå‘½ä¸­åˆ™ä¸è½¬å‘ï¼‰</h2>
          </div>
          <div class="p-6">
            <div class="flex flex-wrap gap-2 mb-3">
              ${(acc.excludeKeywords || []).map(k => `
                <span class="inline-flex items-center gap-1 px-2.5 py-1 rounded-full bg-amber-50 text-amber-700 text-sm border border-amber-100">
                  ${k} <button onclick="removeKeyword('excludeKeywords', '${k}')" class="hover:text-amber-900">âœ•</button>
                </span>
              `).join('')}
              <input type="text" placeholder="è¾“å…¥å±è”½è¯åå›è½¦..." onkeydown="if(event.key==='Enter') addKeyword('excludeKeywords', this.value); this.value='';" 
                class="flex-1 min-w-[120px] px-3 py-1 border-none focus:outline-none text-sm">
            </div>
          </div>
        </div>

        <!-- æ›¿æ¢è§„åˆ™ -->
        <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden mb-4">
          <div class="px-6 py-4 border-b border-slate-100 bg-slate-50/50">
            <h2 class="font-semibold text-slate-800">å…³é”®è¯æ›¿æ¢</h2>
          </div>
          <div class="p-6 space-y-2" id="replacementsList">
            ${renderReplacements(acc.replacements || [])}
          </div>
        </div>
      `;
    }

    function renderMappings(mappings) {
      if (mappings.length === 0) {
        return '<div class="text-center py-8 text-slate-400 text-sm">æš‚æ— è½¬å‘è§„åˆ™ï¼Œç‚¹å‡»ä¸‹æ–¹æ·»åŠ </div>';
      }
      return mappings.map((m, idx) => `
        <div class="flex gap-3 items-center p-3 rounded-lg border border-slate-100 bg-slate-50/30">
          <input type="text" value="${m.sourceChannelId || ''}" onchange="updateMapping(${idx}, 'sourceChannelId', this.value)" 
            placeholder="æ¥æºé¢‘é“ ID" class="w-48 px-3 py-2 border border-slate-200 rounded-lg text-sm font-mono">
          <span class="text-slate-300">â†’</span>
          <input type="text" value="${m.targetWebhookUrl || ''}" onchange="updateMapping(${idx}, 'targetWebhookUrl', this.value)" 
            placeholder="ç›®æ ‡ Webhook URL" class="flex-1 px-3 py-2 border border-slate-200 rounded-lg text-sm font-mono">
          <input type="text" value="${m.note || ''}" onchange="updateMapping(${idx}, 'note', this.value)" 
            placeholder="å¤‡æ³¨" class="w-32 px-3 py-1.5 border border-dashed border-slate-200 rounded-lg text-xs">
          <button onclick="removeMapping(${idx})" class="p-2 text-slate-400 hover:text-red-500">ğŸ—‘ï¸</button>
        </div>
      `).join('');
    }

    function renderReplacements(replacements) {
      return replacements.map((r, idx) => `
        <div class="flex gap-2 items-center">
          <input type="text" value="${r.from || ''}" onchange="updateReplacement(${idx}, 'from', this.value)" 
            placeholder="åŸè¯" class="w-40 px-3 py-1.5 border border-slate-200 rounded-lg text-sm font-mono">
          <span class="text-slate-400">â†’</span>
          <input type="text" value="${r.to || ''}" onchange="updateReplacement(${idx}, 'to', this.value)" 
            placeholder="æ›¿æ¢ä¸º" class="flex-1 px-3 py-1.5 border border-slate-200 rounded-lg text-sm font-mono">
          <button onclick="removeReplacement(${idx})" class="p-2 text-slate-400 hover:text-red-500">ğŸ—‘ï¸</button>
        </div>
      `).join('') + '<button onclick="addReplacement()" class="text-xs bg-slate-50 text-slate-700 px-2 py-1 rounded-md hover:bg-slate-100 mt-2">+ æ·»åŠ æ›¿æ¢è§„åˆ™</button>';
    }

    // å·¥å…·å‡½æ•°
    function getActiveAccount() {
      return state.accounts.find(a => a.id === state.activeId) || state.accounts[0];
    }

    function updateField(field, value) {
      const acc = getActiveAccount();
      acc[field] = value;
      // å¦‚æœåˆ é™¤æœºå™¨äººä¸­è½¬Tokenï¼Œè‡ªåŠ¨é‡ç½®çŠ¶æ€
      if (field === 'botRelayToken' && (!value || !value.trim())) {
        acc.botRelayLoginState = 'idle';
        acc.botRelayLoginMessage = '';
      }
      saveConfig();
      render();
    }

    function switchAccount(id) {
      state.activeId = id;
      render();
    }

    function addAccount() {
      const newAcc = {
        id: genId(),
        name: `è½¬å‘å®ä¾‹${state.accounts.length + 1}`,
        type: 'selfbot',
        token: '',
        proxyUrl: '',
        loginRequested: false,
        loginState: 'idle',
        showSourceIdentity: false,
        mappings: [],
        blockedKeywords: [],
        excludeKeywords: [],
        replacements: [],
        allowedUsersIds: [],
        mutedUsersIds: [],
        enableTranslation: false,
        translationProvider: 'deepseek',
        translationApiKey: '',
        translationSecret: '',
        deepseekApiKey: '',
        enableBotRelay: false,
        botRelayToken: '',
        botRelayLoginState: 'idle',
        botRelayLoginMessage: '',
        ignoreSelf: false,
        ignoreBot: false,
        ignoreImages: false,
        ignoreAudio: false,
        ignoreVideo: false,
        ignoreDocuments: false
      };
      state.accounts.push(newAcc);
      state.activeId = newAcc.id;
      saveConfig();
      render();
    }

    function removeAccount() {
      if (state.accounts.length <= 1) return;
      if (!confirm('ç¡®å®šè¦åˆ é™¤å½“å‰è½¬å‘å®ä¾‹å—ï¼Ÿ')) return;
      state.accounts = state.accounts.filter(a => a.id !== state.activeId);
      state.activeId = state.accounts[0]?.id || '';
      saveConfig();
      render();
    }

    function addMapping() {
      const acc = getActiveAccount();
      if (!acc.mappings) acc.mappings = [];
      acc.mappings.push({ id: genId(), sourceChannelId: '', targetWebhookUrl: '', note: '' });
      saveConfig();
      render();
    }

    function updateMapping(idx, field, value) {
      const acc = getActiveAccount();
      if (acc.mappings[idx]) {
        acc.mappings[idx][field] = value;
        saveConfig();
      }
    }

    function removeMapping(idx) {
      const acc = getActiveAccount();
      acc.mappings.splice(idx, 1);
      saveConfig();
      render();
    }

    function addKeyword(field, value) {
      if (!value.trim()) return;
      const acc = getActiveAccount();
      if (!acc[field]) acc[field] = [];
      if (!acc[field].includes(value.trim())) {
        acc[field].push(value.trim());
        saveConfig();
        render();
      }
    }

    function removeKeyword(field, keyword) {
      const acc = getActiveAccount();
      acc[field] = acc[field].filter(k => k !== keyword);
      saveConfig();
      render();
    }

    function addReplacement() {
      const acc = getActiveAccount();
      if (!acc.replacements) acc.replacements = [];
      acc.replacements.push({ from: '', to: '' });
      saveConfig();
      render();
    }

    function updateReplacement(idx, field, value) {
      const acc = getActiveAccount();
      if (acc.replacements[idx]) {
        acc.replacements[idx][field] = value;
        saveConfig();
      }
    }

    function removeReplacement(idx) {
      const acc = getActiveAccount();
      acc.replacements.splice(idx, 1);
      saveConfig();
      render();
    }

    async function requestLogin() {
      const acc = getActiveAccount();
      if (acc.loginState === 'online' || acc.loginState === 'pending') return;
      
      acc.loginState = 'pending';
      acc.loginMessage = 'æ­£åœ¨ç™»å½•...';
      render();

      try {
        const res = await fetch('/api/account/action', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ accountId: acc.id, action: 'login' })
        });
        const data = await res.json();
        if (!res.ok && data.loginState === 'online') {
          acc.loginState = 'online';
          acc.loginMessage = 'å·²ç™»å½•';
        }
      } catch (e) {
        acc.loginState = 'idle';
        acc.loginMessage = 'ç™»å½•è¯·æ±‚å¤±è´¥';
      }
      render();
    }

    async function requestStop() {
      const acc = getActiveAccount();
      if (acc.loginState === 'pending' || (acc.loginState !== 'online' && acc.loginState !== 'error')) return;
      
      acc.loginState = 'idle';
      acc.loginMessage = 'æ­£åœ¨åœæ­¢...';
      render();

      try {
        const res = await fetch('/api/account/action', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ accountId: acc.id, action: 'stop' })
        });
        const data = await res.json();
        if (res.ok) {
          acc.loginState = data.loginState || 'idle';
          acc.loginMessage = data.loginMessage || 'å·²åœæ­¢';
        }
      } catch (e) {
        acc.loginState = acc.loginState || 'idle';
        acc.loginMessage = 'åœæ­¢è¯·æ±‚å¤±è´¥';
      }
      render();
    }

    async function requestBotRelayLogin() {
      const acc = getActiveAccount();
      // å¦‚æœå·²ç»åœ¨pendingæˆ–onlineçŠ¶æ€ï¼Œä¸å…è®¸é‡å¤è¯·æ±‚
      if (acc.botRelayLoginState === 'online' || acc.botRelayLoginState === 'pending') {
        console.log('[å‰ç«¯] æœºå™¨äººä¸­è½¬ç™»å½•: çŠ¶æ€ä¸º', acc.botRelayLoginState, 'ï¼Œè·³è¿‡è¯·æ±‚');
        return;
      }
      
      // æ£€æŸ¥tokenæ˜¯å¦å­˜åœ¨
      if (!acc.botRelayToken || !acc.botRelayToken.trim()) {
        acc.botRelayLoginState = 'error';
        acc.botRelayLoginMessage = 'Token æœªé…ç½®';
        saveConfig();
        render();
        return;
      }
      
      // ç«‹å³æ›´æ–°æœ¬åœ°çŠ¶æ€ä¸ºpending
      acc.botRelayLoginState = 'pending';
      acc.botRelayLoginMessage = 'æ­£åœ¨éªŒè¯ Token...';
      saveConfig();
      render();

      try {
        console.log('[å‰ç«¯] æœºå™¨äººä¸­è½¬ç™»å½•: å‘é€éªŒè¯è¯·æ±‚ï¼ŒaccountId:', acc.id);
        const res = await fetch('/api/account/action', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ accountId: acc.id, action: 'botRelayLogin' })
        });
        
        const data = await res.json();
        console.log('[å‰ç«¯] æœºå™¨äººä¸­è½¬ç™»å½•å“åº”:', { status: res.status, ok: res.ok, data });
        
        // æ— è®ºres.okæ˜¯trueè¿˜æ˜¯falseï¼Œéƒ½æ›´æ–°çŠ¶æ€ï¼ˆå› ä¸ºéªŒè¯å¤±è´¥æ—¶ä¹Ÿä¼šè¿”å›çŠ¶æ€ï¼‰
        if (data.botRelayLoginState) {
          acc.botRelayLoginState = data.botRelayLoginState;
          acc.botRelayLoginMessage = data.botRelayLoginMessage || '';
          console.log('[å‰ç«¯] æœºå™¨äººä¸­è½¬ç™»å½•: æ›´æ–°çŠ¶æ€ä¸º', acc.botRelayLoginState, 'æ¶ˆæ¯:', acc.botRelayLoginMessage);
        } else if (data.error) {
          // å¦‚æœè¿”å›é”™è¯¯ï¼Œè®¾ç½®ä¸ºerrorçŠ¶æ€
          acc.botRelayLoginState = 'error';
          acc.botRelayLoginMessage = data.error || 'éªŒè¯å¤±è´¥';
          console.error('[å‰ç«¯] æœºå™¨äººä¸­è½¬ç™»å½•: è¿”å›é”™è¯¯', data.error);
        } else {
          // å¦‚æœæ²¡æœ‰è¿”å›çŠ¶æ€ï¼Œæ ¹æ®res.okåˆ¤æ–­
          acc.botRelayLoginState = res.ok ? 'online' : 'error';
          acc.botRelayLoginMessage = res.ok ? 'éªŒè¯æˆåŠŸ' : (data.error || 'éªŒè¯å¤±è´¥');
        }
        
        // ä¿å­˜çŠ¶æ€
        saveConfig();
      } catch (e) {
        console.error('[å‰ç«¯] æœºå™¨äººä¸­è½¬ç™»å½•è¯·æ±‚å¤±è´¥:', e);
        acc.botRelayLoginState = 'error';
        acc.botRelayLoginMessage = `è¯·æ±‚å¤±è´¥: ${e?.message || 'ç½‘ç»œé”™è¯¯'}`;
        saveConfig();
      }
      render();
    }

    async function requestBotRelayStop() {
      const acc = getActiveAccount();
      if (acc.botRelayLoginState === 'pending' || (acc.botRelayLoginState !== 'online' && acc.botRelayLoginState !== 'error')) return;
      
      acc.botRelayLoginState = 'idle';
      acc.botRelayLoginMessage = 'æ­£åœ¨åœæ­¢...';
      render();

      try {
        const res = await fetch('/api/account/action', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ accountId: acc.id, action: 'botRelayStop' })
        });
        const data = await res.json();
        if (res.ok) {
          acc.botRelayLoginState = data.botRelayLoginState || 'idle';
          acc.botRelayLoginMessage = data.botRelayLoginMessage || 'å·²åœæ­¢';
        }
      } catch (e) {
        acc.botRelayLoginState = acc.botRelayLoginState || 'idle';
        acc.botRelayLoginMessage = 'åœæ­¢è¯·æ±‚å¤±è´¥';
      }
      render();
    }

    function showHelp() {
      document.getElementById('helpPanel').classList.remove('hidden');
    }

    function hideHelp() {
      document.getElementById('helpPanel').classList.add('hidden');
    }

    async function exportConfig() {
      try {
        const res = await fetch('/api/config');
        const data = await res.json();
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `discord-forwarder-config-${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.json`;
        a.click();
        URL.revokeObjectURL(url);
      } catch (e) {
        alert('å¯¼å‡ºå¤±è´¥: ' + e.message);
      }
    }

    // çŠ¶æ€è½®è¯¢
    function startStatusPolling() {
      setInterval(async () => {
        try {
          const res = await fetch('/api/config');
          const data = await res.json();
          if (Array.isArray(data?.accounts)) {
            const hasChange = data.accounts.some((ra, idx) => {
              const la = state.accounts[idx];
              if (!la) return false;
              return (
                ra.loginState !== la.loginState || 
                ra.loginMessage !== la.loginMessage ||
                (ra.botRelayLoginState !== undefined && (ra.botRelayLoginState !== la.botRelayLoginState || ra.botRelayLoginMessage !== la.botRelayLoginMessage))
              );
            });
            if (hasChange) {
              state.accounts.forEach((acc, idx) => {
                const remote = data.accounts[idx];
                if (remote && acc.id === remote.id) {
                  if (acc.loginState !== 'pending' || remote.loginState !== 'idle') {
                    acc.loginState = remote.loginState || acc.loginState;
                    acc.loginMessage = remote.loginMessage || acc.loginMessage;
                  }
                  // æ›´æ–°æœºå™¨äººä¸­è½¬çŠ¶æ€
                  // å¦‚æœè¿œç¨‹çŠ¶æ€å­˜åœ¨ï¼Œä¸”ï¼ˆè¿œç¨‹ä¸æ˜¯pending æˆ– æœ¬åœ°æ˜¯pendingï¼‰ï¼Œåˆ™æ›´æ–°
                  // è¿™æ ·å¯ä»¥ç¡®ä¿ï¼š1) pendingçŠ¶æ€ä¸ä¼šè¢«épendingçŠ¶æ€è¦†ç›– 2) pendingçŠ¶æ€å¯ä»¥è¢«æœ€ç»ˆç»“æœè¦†ç›–
                  if (remote.botRelayLoginState !== undefined) {
                    // å¦‚æœè¿œç¨‹çŠ¶æ€ä¸æ˜¯ pendingï¼Œæˆ–è€…æœ¬åœ°çŠ¶æ€æ˜¯ pendingï¼Œåˆ™æ›´æ–°
                    // è¿™æ ·å¯ä»¥ç¡®ä¿ï¼špending çŠ¶æ€ä¸ä¼šè¢«é pending çŠ¶æ€è¦†ç›–ï¼Œä½† pending çŠ¶æ€å¯ä»¥è¢«æœ€ç»ˆç»“æœè¦†ç›–
                    const shouldUpdate = remote.botRelayLoginState !== 'pending' || acc.botRelayLoginState === 'pending';
                    if (shouldUpdate) {
                      const oldState = acc.botRelayLoginState;
                      const oldMessage = acc.botRelayLoginMessage;
                      acc.botRelayLoginState = remote.botRelayLoginState;
                      acc.botRelayLoginMessage = remote.botRelayLoginMessage || '';
                      // å¦‚æœçŠ¶æ€æˆ–æ¶ˆæ¯å‘ç”Ÿå˜åŒ–ï¼Œä¿å­˜é…ç½®å¹¶é‡æ–°æ¸²æŸ“
                      if (oldState !== acc.botRelayLoginState || oldMessage !== acc.botRelayLoginMessage) {
                        saveConfig();
                        // ç«‹å³æ¸²æŸ“ï¼Œä¸éœ€è¦ç­‰å¾…ä¸‹ä¸€æ¬¡è½®è¯¢
                        render();
                      }
                    }
                  }
                  // åŒæ­¥tokenï¼Œå¦‚æœtokenè¢«åˆ é™¤ï¼Œé‡ç½®çŠ¶æ€
                  if (remote.botRelayToken !== undefined) {
                    const tokenChanged = remote.botRelayToken !== acc.botRelayToken;
                    if (tokenChanged) {
                      acc.botRelayToken = remote.botRelayToken || '';
                      // å¦‚æœtokenè¢«åˆ é™¤æˆ–æ¸…ç©ºï¼Œé‡ç½®çŠ¶æ€
                      if (!remote.botRelayToken || !remote.botRelayToken.trim()) {
                        acc.botRelayLoginState = 'idle';
                        acc.botRelayLoginMessage = '';
                      }
                    }
                  }
                }
              });
              render();
            }
          }
        } catch (e) {
          // å¿½ç•¥è½®è¯¢é”™è¯¯
        }
      }, 2000);
    }

    // å¯åŠ¨
    init();
  </script>
</body>
</html>

